package operator

import (
	"context"
	"fmt"
	"strings"
	"time"

	"github.com/yanshicheng/kube-onec/common/k8smanager/types"
	networkingv1 "k8s.io/api/networking/v1"
	"k8s.io/apimachinery/pkg/api/errors"
	metav1 "k8s.io/apimachinery/pkg/apis/meta/v1"
	"k8s.io/apimachinery/pkg/labels"
	"k8s.io/client-go/informers"
	"k8s.io/client-go/kubernetes"
	networkingv1lister "k8s.io/client-go/listers/networking/v1"
	"sigs.k8s.io/yaml"
)

type ingressClassOperator struct {
	BaseOperator
	client             kubernetes.Interface
	informerFactory    informers.SharedInformerFactory
	ingressClassLister networkingv1lister.IngressClassLister
}

func NewIngressClassOperator(ctx context.Context, client kubernetes.Interface) types.IngressClassOperator {
	return &ingressClassOperator{
		BaseOperator: NewBaseOperator(ctx, false),
		client:       client,
	}
}

func NewIngressClassOperatorWithInformer(
	ctx context.Context,
	client kubernetes.Interface,
	informerFactory informers.SharedInformerFactory,
) types.IngressClassOperator {
	var ingressClassLister networkingv1lister.IngressClassLister

	if informerFactory != nil {
		ingressClassLister = informerFactory.Networking().V1().IngressClasses().Lister()
	}

	return &ingressClassOperator{
		BaseOperator:       NewBaseOperator(ctx, informerFactory != nil),
		client:             client,
		informerFactory:    informerFactory,
		ingressClassLister: ingressClassLister,
	}
}

// Get 获取指定的 IngressClass
func (i *ingressClassOperator) Get(name string) (*networkingv1.IngressClass, error) {
	if name == "" {
		return nil, fmt.Errorf("IngressClass名称不能为空")
	}

	// 优先使用 informer
	if i.useInformer && i.ingressClassLister != nil {
		ingressClass, err := i.ingressClassLister.Get(name)
		if err != nil {
			if errors.IsNotFound(err) {
				return nil, fmt.Errorf("IngressClass %s 不存在", name)
			}
			// informer 出错时回退到 API 调用
			ingressClass, apiErr := i.client.NetworkingV1().IngressClasses().Get(i.ctx, name, metav1.GetOptions{})
			if apiErr != nil {
				return nil, fmt.Errorf("获取IngressClass失败: %v", apiErr)
			}
			return ingressClass, nil
		}
		return ingressClass, nil
	}

	// 使用 API 调用
	ingressClass, err := i.client.NetworkingV1().IngressClasses().Get(i.ctx, name, metav1.GetOptions{})
	if err != nil {
		if errors.IsNotFound(err) {
			return nil, fmt.Errorf("IngressClass %s 不存在", name)
		}
		return nil, fmt.Errorf("获取IngressClass失败: %v", err)
	}

	return ingressClass, nil
}

// List 获取 IngressClass 列表，支持 search 和 labelSelector 过滤
func (i *ingressClassOperator) List(search string, labelSelector string) (*types.ListIngressClassResponse, error) {
	var selector labels.Selector = labels.Everything()
	if labelSelector != "" {
		parsedSelector, err := labels.Parse(labelSelector)
		if err != nil {
			return nil, fmt.Errorf("解析标签选择器失败: %v", err)
		}
		selector = parsedSelector
	}

	var ingressClasses []*networkingv1.IngressClass
	var err error

	// 优先使用 informer
	if i.useInformer && i.ingressClassLister != nil {
		ingressClasses, err = i.ingressClassLister.List(selector)
		if err != nil {
			return nil, fmt.Errorf("获取IngressClass列表失败: %v", err)
		}
	} else {
		// 使用 API 调用
		listOpts := metav1.ListOptions{LabelSelector: selector.String()}
		ingressClassList, err := i.client.NetworkingV1().IngressClasses().List(i.ctx, listOpts)
		if err != nil {
			return nil, fmt.Errorf("获取IngressClass列表失败: %v", err)
		}
		ingressClasses = make([]*networkingv1.IngressClass, len(ingressClassList.Items))
		for idx := range ingressClassList.Items {
			ingressClasses[idx] = &ingressClassList.Items[idx]
		}
	}

	// 搜索过滤
	if search != "" {
		filtered := make([]*networkingv1.IngressClass, 0)
		searchLower := strings.ToLower(search)
		for _, ic := range ingressClasses {
			if strings.Contains(strings.ToLower(ic.Name), searchLower) ||
				strings.Contains(strings.ToLower(ic.Spec.Controller), searchLower) {
				filtered = append(filtered, ic)
			}
		}
		ingressClasses = filtered
	}

	// 转换为响应格式
	items := make([]types.IngressClassInfo, len(ingressClasses))
	for idx, ic := range ingressClasses {
		items[idx] = types.IngressClassInfo{
			Name:              ic.Name,
			Controller:        ic.Spec.Controller,
			IsDefault:         isDefaultIngressClass(ic),
			Parameters:        convertParameters(ic.Spec.Parameters),
			Labels:            ic.Labels,
			Annotations:       ic.Annotations,
			Age:               time.Since(ic.CreationTimestamp.Time).String(),
			CreationTimestamp: ic.CreationTimestamp.UnixMilli(),
		}
	}

	return &types.ListIngressClassResponse{
		Total: len(items),
		Items: items,
	}, nil
}

// GetYaml 获取 IngressClass 的 YAML 表示
func (i *ingressClassOperator) GetYaml(name string) (string, error) {
	ingressClass, err := i.Get(name)
	if err != nil {
		return "", err
	}

	// 清除 managedFields
	ingressClass.ManagedFields = nil

	yamlBytes, err := yaml.Marshal(ingressClass)
	if err != nil {
		return "", fmt.Errorf("转换为YAML失败: %v", err)
	}

	return string(yamlBytes), nil
}

// GetDefault 获取默认的 IngressClass
func (i *ingressClassOperator) GetDefault() (*networkingv1.IngressClass, error) {
	var ingressClasses []*networkingv1.IngressClass
	var err error

	// 优先使用 informer
	if i.useInformer && i.ingressClassLister != nil {
		ingressClasses, err = i.ingressClassLister.List(labels.Everything())
		if err != nil {
			return nil, fmt.Errorf("获取IngressClass列表失败: %v", err)
		}
	} else {
		// 使用 API 调用
		ingressClassList, err := i.client.NetworkingV1().IngressClasses().List(i.ctx, metav1.ListOptions{})
		if err != nil {
			return nil, fmt.Errorf("获取IngressClass列表失败: %v", err)
		}
		ingressClasses = make([]*networkingv1.IngressClass, len(ingressClassList.Items))
		for idx := range ingressClassList.Items {
			ingressClasses[idx] = &ingressClassList.Items[idx]
		}
	}

	// 查找默认的 IngressClass
	for _, ic := range ingressClasses {
		if isDefaultIngressClass(ic) {
			return ic, nil
		}
	}

	return nil, fmt.Errorf("未找到默认的IngressClass")
}

// isDefaultIngressClass 判断是否为默认的 IngressClass
func isDefaultIngressClass(ic *networkingv1.IngressClass) bool {
	if ic.Annotations == nil {
		return false
	}

	// 检查标准注解
	if val, ok := ic.Annotations["ingressclass.kubernetes.io/is-default-class"]; ok {
		return val == "true"
	}

	return false
}

// convertParameters 转换 IngressClass 参数
func convertParameters(params *networkingv1.IngressClassParametersReference) *types.IngressClassParameters {
	if params == nil {
		return nil
	}

	result := &types.IngressClassParameters{
		Kind: params.Kind,
		Name: params.Name,
	}

	if params.APIGroup != nil {
		result.APIGroup = *params.APIGroup
	}

	if params.Namespace != nil {
		result.Namespace = *params.Namespace
	}

	if params.Scope != nil {
		result.Scope = *params.Scope
	}

	return result
}
