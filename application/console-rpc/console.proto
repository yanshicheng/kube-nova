syntax = "proto3";

option go_package = "github.com/yanshicheng/kube-nova/application/console-rpc/pb";

package pb;

//================================é•œåƒä»“åº“åŸºç¡€æ•°æ®ç»“æ„================================
message ContainerRegistry {
  uint64 id = 1;
  string name = 2;
  string uuid = 3;
  string type = 4;                    // harbor, docker-registry, nexus
  string env = 5;                     // dev, test, staging, prod
  string url = 6;
  string username = 7;
  string password = 8;
  bool insecure = 9;                  // æ˜¯å¦è·³è¿‡è¯ä¹¦éªŒè¯
  string caCert = 10;                 // CA è¯ä¹¦å†…å®¹
  string config = 11;                 // JSON æ ¼å¼çš„æ‰©å±•é…ç½®
  int32 status = 12;                  // 0-ç¦ç”¨, 1-å¯ç”¨
  string description = 13;
  string createdBy = 14;
  string updatedBy = 15;
  int64 createdAt = 16;
  int64 updatedAt = 17;
  int64 totalProjects = 21;
  int64 storageTotal = 18;
  int64 totalRepositories = 19;
}

message ContainerRegistryDetails {
  uint64 id = 1;
  string name = 2;
  string uuid = 3;
  string type = 4;
  string env = 5;
  string url = 6;
  string username = 7;
  string password = 8;
  bool insecure = 9;
  string caCert = 10;
  string config = 11;
  int32 status = 12;
  string description = 13;
  string createdBy = 14;
  string updatedBy = 15;
  int64 createdAt = 16;
  int64 updatedAt = 17;
  // ç»Ÿè®¡ä¿¡æ¯ï¼ˆä»…æ”¯æŒçš„ä»“åº“ç±»å‹ï¼‰
  int64 storageTotal = 18;
  int64 storageUsed = 19;
  int64 storageFree = 20;
  int64 totalProjects = 21;
  int64 publicProjects = 22;
  int64 privateProjects = 23;
  int64 totalRepositories = 24;
  int64 publicRepositories = 25;
  int64 privateRepositories = 26;
}

//================================ä»“åº“ä¸é›†ç¾¤å…³è”æ•°æ®ç»“æ„================================
message RegistryCluster {
  uint64 id = 1;
  uint64 registryId = 2;
  string clusterUuid = 3;
  int64 createdAt = 4;
  int64 updatedAt = 5;
  // å…³è”çš„ä»“åº“ä¿¡æ¯ï¼ˆæŸ¥è¯¢æ—¶è¿”å›ï¼‰
  ContainerRegistry registry = 6;
}

//================================ä»“åº“é¡¹ç›®ä¸åº”ç”¨é¡¹ç›®ç»‘å®šæ•°æ®ç»“æ„================================
message RegistryProjectBinding {
  uint64 id = 1;
  uint64 registryId = 2;
  uint64 appProjectId = 3;
  string registryProjectName = 4;   // ä»“åº“ä¸­çš„é¡¹ç›®åç§°
  string registryProjectId = 5;     // ä»“åº“ä¸­çš„é¡¹ç›®IDï¼ˆå¯é€‰ï¼‰
  int64 createdAt = 6;
  int64 updatedAt = 7;
  // å…³è”ä¿¡æ¯ï¼ˆæŸ¥è¯¢æ—¶è¿”å›ï¼‰
  ContainerRegistry registry = 8;
  string clusterUuid = 9;
}

//================================é•œåƒä»“åº“ CRUDï¼ˆç®¡ç†å‘˜æ“ä½œï¼‰================================
message CreateRegistryReq {
  string name = 1;
  string type = 2;
  string env = 3;
  string url = 4;
  string username = 5;
  string password = 6;
  bool insecure = 7;
  string caCert = 8;
  string config = 9;                // JSON æ ¼å¼å­—ç¬¦ä¸²
  int32 status = 10;
  string description = 11;
  string createdBy = 12;
}
message CreateRegistryResp {
  string uuid = 1;
  string message = 2;
}

message UpdateRegistryReq {
  uint64 id = 1;
  string name = 2;
  string type = 3;
  string env = 4;
  string url = 5;
  string username = 6;
  string password = 7;
  bool insecure = 8;
  string caCert = 9;
  string config = 10;
  int32 status = 11;
  string description = 12;
  string updatedBy = 13;
}
message UpdateRegistryResp {
  string message = 1;
}

message DeleteRegistryReq {
  uint64 id = 1;
}
message DeleteRegistryResp {
  string message = 1;
}

message GetRegistryByUuidReq {
  string uuid = 1;
}
message GetRegistryByUuidResp {
  ContainerRegistry data = 1;
}

message GetRegistryDetailsReq {
  string uuid = 1;
}
message GetRegistryDetailsResp {
  ContainerRegistryDetails data = 1;
}

message TestRegistryConnectionReq {
  string url = 1;
  string username = 2;
  string password = 3;
  bool insecure = 4;
  string caCert = 5;
  string type = 6;                  // ä»“åº“ç±»å‹
}
message TestRegistryConnectionResp {
  bool success = 1;
  string message = 2;
}

//================================ä»“åº“æŸ¥è¯¢ï¼ˆç®¡ç†å‘˜è§†è§’ + é¡¹ç›®è§†è§’ï¼‰================================
// ç®¡ç†å‘˜è§†è§’ï¼šæŸ¥è¯¢æ‰€æœ‰ä»“åº“
message ListRegistriesReq {
  uint64 page = 1;
  uint64 pageSize = 2;
  string orderBy = 3;
  bool isAsc = 4;
  string name = 5;
  string uuid = 6;
  string env = 7;
  string type = 8;
  int32 status = 9;
}
message ListRegistriesResp {
  repeated ContainerRegistry data = 1;
  uint64 total = 2;
}

// é¡¹ç›®è§†è§’ï¼šæŸ¥è¯¢é¡¹ç›®å…³è”çš„ä»“åº“ï¼ˆéœ€è¦ä¼ é¡¹ç›®IDå’Œé›†ç¾¤UUIDï¼‰
message ListRegistriesByProjectReq {
  uint64 appProjectId = 1;          // å¿…å¡«
  string clusterUuid = 2;           // å¿…å¡«
  uint64 page = 3;
  uint64 pageSize = 4;
  string orderBy = 5;
  bool isAsc = 6;
  string name = 7;
  string env = 8;
  string type = 9;
}
message ListRegistriesByProjectResp {
  repeated ContainerRegistry data = 1;
  uint64 total = 2;
}

//================================ä»“åº“ä¸é›†ç¾¤å…³è” CRUDï¼ˆç®¡ç†å‘˜æ“ä½œï¼‰================================
message BindRegistryToClusterReq {
  uint64 registryId = 1;
  string clusterUuid = 2;
}
message BindRegistryToClusterResp {
  uint64 id = 1;
  string message = 2;
}

message UnbindRegistryFromClusterReq {
  uint64 id = 1;                    // registry_cluster è¡¨çš„ ID
}
message UnbindRegistryFromClusterResp {
  string message = 1;
}

message ListClusterRegistriesReq {
  string clusterUuid = 1;
  uint64 registryId = 2;            // å¯é€‰ï¼šç­›é€‰ç‰¹å®šä»“åº“
}
message ListClusterRegistriesResp {
  repeated RegistryCluster data = 1;
}

message ListRegistryClustersReq {
  uint64 registryId = 1;            // æŸ¥è¯¢æŸä¸ªä»“åº“å…³è”çš„æ‰€æœ‰é›†ç¾¤
}
message ListRegistryClustersResp {
  repeated RegistryCluster data = 1;
}

//================================ä»“åº“é¡¹ç›®ä¸åº”ç”¨é¡¹ç›®ç»‘å®š CRUDï¼ˆç®¡ç†å‘˜æ“ä½œï¼‰================================
message BindRegistryProjectReq {
  uint64 registryId = 1;     // registry_cluster è¡¨çš„ ID
  uint64 appProjectId = 2;
  string registryProjectName = 3;   // ä»“åº“ä¸­çš„é¡¹ç›®åç§°
  string registryProjectId = 4;     // å¯é€‰ï¼šä»“åº“ä¸­çš„é¡¹ç›®ID
}
message BindRegistryProjectResp {
  uint64 id = 1;
  string message = 2;
}

message UnbindRegistryProjectReq {
  uint64 id = 1;                    // registry_project_binding è¡¨çš„ ID
}
message UnbindRegistryProjectResp {
  string message = 1;
}

message ListProjectRegistryBindingsReq {
  uint64 registryId = 3;            // å¯é€‰ï¼šç­›é€‰ç‰¹å®šä»“åº“
  string registryProjectName = 4;
}

message BindProjectIds {
  uint64 id = 1;
  uint64 projectId = 2;
}
message ListProjectRegistryBindingsResp {
  repeated BindProjectIds data = 1;
}

//================================ä»“åº“é¡¹ç›®æ“ä½œ================================
message RegistryProject {
  int64 projectId = 1;
  string name = 2;
  string ownerName = 3;
  bool isPublic = 4;
  int64 repoCount = 5;
  int64 creationTime = 6;
  int64 updateTime = 7;
  // æ–°å¢ï¼šå­˜å‚¨ä¿¡æ¯
  int64 storageLimit = 8;           // å­˜å‚¨é…é¢é™åˆ¶ï¼ˆå­—èŠ‚ï¼‰
  int64 storageUsed = 9;            // å·²ä½¿ç”¨å­˜å‚¨ï¼ˆå­—èŠ‚ï¼‰
  string storageLimitDisplay = 10;  // å­˜å‚¨é…é¢æ˜¾ç¤ºï¼ˆå¦‚ "10GB"ï¼‰
  string storageUsedDisplay = 11;   // å·²ä½¿ç”¨å­˜å‚¨æ˜¾ç¤ºï¼ˆå¦‚ "5.2GB"ï¼‰
}

// ç®¡ç†å‘˜è§†è§’ï¼šæŸ¥è¯¢ä»“åº“çš„æ‰€æœ‰é¡¹ç›®
message ListProjectsReq {
  string registryUuid = 1;          // å¿…å¡«ï¼šä»“åº“ UUID
  string search = 2;
  int64 page = 3;
  int64 pageSize = 4;
  string sortBy = 5;
  bool sortDesc = 6;
}
message ListProjectsResp {
  repeated RegistryProject items = 1;
  int64 total = 2;
  int64 page = 3;
  int64 pageSize = 4;
  int64 totalPages = 5;
}

// é¡¹ç›®è§†è§’ï¼šæŸ¥è¯¢åº”ç”¨é¡¹ç›®å…³è”çš„ä»“åº“é¡¹ç›®ï¼ˆç§æœ‰é¡¹ç›® + å…¬å¼€é¡¹ç›®ï¼‰
message ListProjectsByAppReq {
  uint64 appProjectId = 1;          // å¿…å¡«ï¼šåº”ç”¨é¡¹ç›® ID
  string clusterUuid = 2;           // å¿…å¡«ï¼šé›†ç¾¤ UUID
  string registryUuid = 3;          // å¿…å¡«ï¼šä»“åº“ UUID
  string search = 4;
  int64 page = 5;
  int64 pageSize = 6;
  string sortBy = 7;
  bool sortDesc = 8;
}
message ListProjectsByAppResp {
  repeated RegistryProject items = 1;
  int64 total = 2;
  int64 page = 3;
  int64 pageSize = 4;
  int64 totalPages = 5;
}

message GetProjectReq {
  string registryUuid = 1;
  string projectName = 2;
}
message GetProjectResp {
  RegistryProject data = 1;
}

message CreateProjectReq {
  string registryUuid = 1;
  string projectName = 2;
  bool isPublic = 3;
  int64 storageLimit = 4;           // ğŸ”§ æ”¹ä¸º int64
  string storageUnit = 7;           // ğŸ†• æ–°å¢ï¼šæ”¯æŒ MBã€GBã€TBï¼Œé»˜è®¤ä¸º GB
  uint64 appProjectId = 5;          // å¯é€‰ï¼šåˆ›å»ºæ—¶ç›´æ¥ç»‘å®šåˆ°åº”ç”¨é¡¹ç›®
  string clusterUuid = 6;           // å¯é€‰ï¼šä¸ appProjectId é…åˆä½¿ç”¨
}
message CreateProjectResp {
  int64 projectId = 1;
  string message = 2;
}

message UpdateProjectReq {
  string registryUuid = 1;
  string projectName = 2;
  bool isPublic = 3;
  int64 storageLimit = 4;           // ğŸ”§ æ”¹ä¸º int64
  string storageUnit = 6;           // ğŸ†• æ–°å¢ï¼šæ”¯æŒ MBã€GBã€TBï¼Œé»˜è®¤ä¸º GB
}

message UpdateProjectResp {
  string message = 1;
}

message DeleteProjectReq {
  string registryUuid = 1;
  string projectName = 2;
}
message DeleteProjectResp {
  string message = 1;
}

//================================ç”¨æˆ·ç®¡ç†================================
message ProjectMember {
  int64 id = 1;
  int64 projectId = 2;
  string entityName = 3;            // ç”¨æˆ·åæˆ–ç”¨æˆ·ç»„å
  string entityType = 4;            // u=ç”¨æˆ·, g=ç”¨æˆ·ç»„
  int64 roleId = 5;                 // è§’è‰²ID: 1=ç®¡ç†å‘˜, 2=å¼€å‘è€…, 3=è®¿å®¢, 4=ç»´æŠ¤è€…
  string roleName = 6;              // è§’è‰²åç§°
  int64 creationTime = 7;
  int64 updateTime = 8;
}

// åˆ—å‡ºé¡¹ç›®æˆå‘˜
message ListProjectMembersReq {
  string registryUuid = 1;
  string projectName = 2;
  string search = 3;                // æœç´¢ç”¨æˆ·å
  int64 page = 4;
  int64 pageSize = 5;
}
message ListProjectMembersResp {
  repeated ProjectMember items = 1;
  int64 total = 2;
  int64 page = 3;
  int64 pageSize = 4;
  int64 totalPages = 5;
}

// æ·»åŠ é¡¹ç›®æˆå‘˜
message AddProjectMemberReq {
  string registryUuid = 1;
  string projectName = 2;
  string memberUser = 3;            // ç”¨æˆ·åæˆ–ç”¨æˆ·ç»„å
  int64 roleId = 4;                 // è§’è‰²ID: 1=ç®¡ç†å‘˜, 2=å¼€å‘è€…, 3=è®¿å®¢, 4=ç»´æŠ¤è€…
}
message AddProjectMemberResp {
  int64 id = 1;
  string message = 2;
}

// æ›´æ–°é¡¹ç›®æˆå‘˜è§’è‰²
message UpdateProjectMemberReq {
  string registryUuid = 1;
  string projectName = 2;
  int64 memberId = 3;               // æˆå‘˜ID
  int64 roleId = 4;                 // æ–°çš„è§’è‰²ID
}
message UpdateProjectMemberResp {
  string message = 1;
}

// åˆ é™¤é¡¹ç›®æˆå‘˜
message DeleteProjectMemberReq {
  string registryUuid = 1;
  string projectName = 2;
  int64 memberId = 3;               // æˆå‘˜ID
}
message DeleteProjectMemberResp {
  string message = 1;
}

// è·å–é¡¹ç›®æˆå‘˜è¯¦æƒ…
message GetProjectMemberReq {
  string registryUuid = 1;
  string projectName = 2;
  int64 memberId = 3;
}
message GetProjectMemberResp {
  ProjectMember data = 1;
}

//================================ä»“åº“ Repository æ“ä½œ================================
message Repository {
  int64 id = 1;
  string name = 2;
  int64 projectId = 3;
  string projectName = 4;
  string description = 5;
  int64 artifactCount = 6;
  int64 pullCount = 7;
  int64 creationTime = 8;
  int64 updateTime = 9;
}

message ListRepositoriesReq {
  string registryUuid = 1;
  string projectName = 2;
  string search = 3;
  int64 page = 4;
  int64 pageSize = 5;
  string sortBy = 6;
  bool sortDesc = 7;
}
message ListRepositoriesResp {
  repeated Repository items = 1;
  int64 total = 2;
  int64 page = 3;
  int64 pageSize = 4;
  int64 totalPages = 5;
}

message GetRepositoryReq {
  string registryUuid = 1;
  string projectName = 2;
  string repoName = 3;
}
message GetRepositoryResp {
  Repository data = 1;
}

message DeleteRepositoryReq {
  string registryUuid = 1;
  string projectName = 2;
  string repoName = 3;
}
message DeleteRepositoryResp {
  string message = 1;
}

//================================åˆ¶å“/æ ‡ç­¾æ“ä½œ================================
message Tag {
  int64 id = 1;
  string name = 2;
  int64 pushTime = 3;
  int64 pullTime = 4;
  bool immutable = 5;
  bool signed = 6;
}

message Artifact {
  int64 id = 1;
  string type = 2;
  string digest = 3;
  repeated Tag tags = 4;
  int64 pushTime = 5;
  int64 pullTime = 6;
  int64 size = 7;
  string manifestMediaType = 8;
}

message ListArtifactsReq {
  string registryUuid = 1;
  string projectName = 2;
  string repoName = 3;
  string search = 4;
  int64 page = 5;
  int64 pageSize = 6;
  string sortBy = 7;
  bool sortDesc = 8;
}
message ListArtifactsResp {
  repeated Artifact items = 1;
  int64 total = 2;
  int64 page = 3;
  int64 pageSize = 4;
  int64 totalPages = 5;
}

message GetArtifactReq {
  string registryUuid = 1;
  string projectName = 2;
  string repoName = 3;
  string reference = 4;              // digest æˆ– tag
}
message GetArtifactResp {
  Artifact data = 1;
}

message DeleteArtifactReq {
  string registryUuid = 1;
  string projectName = 2;
  string repoName = 3;
  string reference = 4;
}
message DeleteArtifactResp {
  string message = 1;
}

message DeleteTagReq {
  string registryUuid = 1;
  string projectName = 2;
  string repoName = 3;
  string tagName = 4;
}
message DeleteTagResp {
  string message = 1;
}

//================================é•œåƒæœç´¢ï¼ˆ4ä¸ªæ¥å£ï¼šç®¡ç†å‘˜è§†è§’2ä¸ª + é¡¹ç›®è§†è§’2ä¸ªï¼‰================================
message ImageSearchResult {
  string projectName = 1;
  string repoName = 2;
  repeated string tags = 3;
  int64 artifactCount = 4;
  int64 pullCount = 5;
}

message RegistryImageSearchResult {
  string registryName = 1;
  string registryUuid = 2;
  string registryUrl = 3;
  repeated ImageSearchResult images = 4;
}

// 1. å…¨å±€æœç´¢-ç®¡ç†å‘˜è§†è§’ï¼šæœç´¢æ‰€æœ‰ä»“åº“æ‰€æœ‰é¡¹ç›®çš„é•œåƒ
message SearchImagesGlobalReq {
  string imageName = 1;             // å¿…å¡«ï¼šé•œåƒåç§°
  string registryType = 2;          // å¯é€‰ï¼šç­›é€‰ä»“åº“ç±»å‹
  string env = 3;                   // å¯é€‰ï¼šç­›é€‰ç¯å¢ƒ
  int64 page = 4;
  int64 pageSize = 5;
}
message SearchImagesGlobalResp {
  repeated RegistryImageSearchResult data = 1;
  int64 total = 2;
}

// 2. å…¨å±€æœç´¢-é¡¹ç›®è§†è§’ï¼šæœç´¢é¡¹ç›®å…³è”çš„ä»“åº“å’Œæœ‰æƒé™çš„é¡¹ç›®ï¼ˆç§æœ‰é¡¹ç›®+å…¬å¼€é¡¹ç›®ï¼‰
message SearchImagesGlobalByProjectReq {
  uint64 appProjectId = 1;          // å¿…å¡«ï¼šåº”ç”¨é¡¹ç›® ID
  string clusterUuid = 2;           // å¿…å¡«ï¼šé›†ç¾¤ UUID
  string imageName = 3;             // å¿…å¡«ï¼šé•œåƒåç§°
  int64 page = 4;
  int64 pageSize = 5;
}
message SearchImagesGlobalByProjectResp {
  repeated RegistryImageSearchResult data = 1;
  int64 total = 2;
}

// 3. ä»“åº“å†…æœç´¢-ç®¡ç†å‘˜è§†è§’ï¼šæœç´¢æŒ‡å®šä»“åº“æ‰€æœ‰é¡¹ç›®çš„é•œåƒ
message SearchImagesInRegistryReq {
  string registryUuid = 1;          // å¿…å¡«ï¼šä»“åº“ UUID
  string imageName = 2;             // å¿…å¡«ï¼šé•œåƒåç§°
  int64 page = 3;
  int64 pageSize = 4;
}
message SearchImagesInRegistryResp {
  repeated ImageSearchResult data = 1;
  int64 total = 2;
}

// 4. ä»“åº“å†…æœç´¢-é¡¹ç›®è§†è§’ï¼šæœç´¢æŒ‡å®šä»“åº“ä¸­é¡¹ç›®å…³è”çš„é¡¹ç›®ï¼ˆç§æœ‰é¡¹ç›®+å…¬å¼€é¡¹ç›®ï¼‰
message SearchImagesInRegistryByProjectReq {
  uint64 appProjectId = 1;          // å¿…å¡«ï¼šåº”ç”¨é¡¹ç›® ID
  string clusterUuid = 2;           // å¿…å¡«ï¼šé›†ç¾¤ UUID
  string registryUuid = 3;          // å¿…å¡«ï¼šä»“åº“ UUID
  string imageName = 4;             // å¿…å¡«ï¼šé•œåƒåç§°
  int64 page = 5;
  int64 pageSize = 6;
}
message SearchImagesInRegistryByProjectResp {
  repeated ImageSearchResult data = 1;
  int64 total = 2;
}

//================================é…é¢ç®¡ç†================================
message ProjectQuota {
  int64 storageLimit = 1;
  int64 storageUsed = 2;
  int64 countLimit = 3;
  int64 countUsed = 4;
}

message GetProjectQuotaReq {
  string registryUuid = 1;
  string projectName = 2;
}
message GetProjectQuotaResp {
  ProjectQuota data = 1;
}

message UpdateProjectQuotaReq {
  string registryUuid = 1;
  string projectName = 2;
  int64 storageLimit = 3;           // âœ… å·²ç»æ˜¯ int64
  string storageUnit = 5;           // âœ… å·²æœ‰ï¼šæ”¯æŒ MBã€GBã€TBï¼Œé»˜è®¤ä¸º GB
  int64 countLimit = 4;
}

message UpdateProjectQuotaResp {
  string message = 1;
}

message HarborUser {
  int64 userId = 1;
  string username = 2;
  string email = 3;
  string realname = 4;           // å…¨å
  string comment = 5;             // æ³¨é‡Š
  int64 creationTime = 6;
  int64 updateTime = 7;
  bool sysadminFlag = 8;          // æ˜¯å¦æ˜¯ç³»ç»Ÿç®¡ç†å‘˜
  bool adminRoleInAuth = 9;     // è®¤è¯ä¸­çš„ç®¡ç†å‘˜è§’è‰²
}

// åˆ›å»ºç”¨æˆ·
message CreateUserReq {
  string registryUuid = 1;        // Harbor ä»“åº“ UUID
  string username = 2;            // ç”¨æˆ·åï¼ˆå¿…å¡«ï¼‰
  string email = 3;               // é‚®ç®±ï¼ˆå¿…å¡«ï¼‰
  string realname = 4;            // å…¨åï¼ˆå¿…å¡«ï¼‰
  string password = 5;            // å¯†ç ï¼ˆå¿…å¡«ï¼‰
  string comment = 6;             // æ³¨é‡Šï¼ˆå¯é€‰ï¼‰
}
message CreateUserResp {
  int64 userId = 1;
  string message = 2;
}

// åˆ—å‡ºç”¨æˆ·
message ListUsersReq {
  string registryUuid = 1;
  string search = 2;              // æœç´¢å…³é”®è¯ï¼ˆç”¨æˆ·åæˆ–é‚®ç®±ï¼‰
  int64 page = 3;
  int64 pageSize = 4;
}
message ListUsersResp {
  repeated HarborUser items = 1;
  int64 total = 2;
  int64 page = 3;
  int64 pageSize = 4;
  int64 totalPages = 5;
}

// è·å–ç”¨æˆ·è¯¦æƒ…
message GetUserReq {
  string registryUuid = 1;
  int64 userId = 2;               // ç”¨æˆ· ID æˆ–ç”¨æˆ·å
}
message GetUserResp {
  HarborUser data = 1;
}

// æ›´æ–°ç”¨æˆ·
message UpdateUserReq {
  string registryUuid = 1;
  int64 userId = 2;
  string email = 3;               // å¯é€‰
  string realname = 4;            // å¯é€‰
  string comment = 5;             // å¯é€‰
}
message UpdateUserResp {
  string message = 1;
}

// åˆ é™¤ç”¨æˆ·
message DeleteUserReq {
  string registryUuid = 1;
  int64 userId = 2;
}
message DeleteUserResp {
  string message = 1;
}

// ä¿®æ”¹ç”¨æˆ·å¯†ç 
message ChangeUserPasswordReq {
  string registryUuid = 1;
  int64 userId = 2;
  string oldPassword = 3;         // æ—§å¯†ç 
  string newPassword = 4;         // æ–°å¯†ç 
}
message ChangeUserPasswordResp {
  string message = 1;
}

// è®¾ç½®ç”¨æˆ·ä¸ºç®¡ç†å‘˜
message SetUserAdminReq {
  string registryUuid = 1;
  int64 userId = 2;
  bool sysadminFlag = 3;          // true=è®¾ä¸ºç®¡ç†å‘˜, false=å–æ¶ˆç®¡ç†å‘˜
}
message SetUserAdminResp {
  string message = 1;
}



//================================åƒåœ¾å›æ”¶ç®¡ç†================================
message GCHistory {
  int64 id = 1;
  string jobName = 2;
  string jobKind = 3;
  string jobStatus = 4;              // Pending, Running, Success, Error
  int64 creationTime = 5;
  int64 updateTime = 6;
  bool deleteUntagged = 7;
  string jobParameters = 8;
}

message GCSchedule {
  string schedule = 1;                // cron è¡¨è¾¾å¼æˆ–ç©ºå­—ç¬¦ä¸²
  map<string, string> parameters = 2; // {"delete_untagged": "true"}
}

// åˆ—å‡º GC å†å²
message ListGCHistoryReq {
  string registryUuid = 1;
  int64 page = 2;
  int64 pageSize = 3;
}
message ListGCHistoryResp {
  repeated GCHistory items = 1;
  int64 total = 2;
  int64 page = 3;
  int64 pageSize = 4;
  int64 totalPages = 5;
}

// è·å– GC è¯¦æƒ…
message GetGCReq {
  string registryUuid = 1;
  int64 gcId = 2;
}
message GetGCResp {
  GCHistory data = 1;
}

// è·å– GC æ—¥å¿—
message GetGCLogReq {
  string registryUuid = 1;
  int64 gcId = 2;
}
message GetGCLogResp {
  string log = 1;
}

// è·å– GC è°ƒåº¦é…ç½®
message GetGCScheduleReq {
  string registryUuid = 1;
}
message GetGCScheduleResp {
  GCSchedule data = 1;
}

// æ›´æ–° GC è°ƒåº¦é…ç½®
message UpdateGCScheduleReq {
  string registryUuid = 1;
  string schedule = 2;                // cron è¡¨è¾¾å¼ï¼Œå¦‚ "0 0 * * *"
  bool deleteUntagged = 3;           // æ˜¯å¦åˆ é™¤æœªæ ‡è®°çš„åˆ¶å“
}
message UpdateGCScheduleResp {
  string message = 1;
}

// æ‰‹åŠ¨è§¦å‘ GC
message TriggerGCReq {
  string registryUuid = 1;
  bool deleteUntagged = 2;           // æ˜¯å¦åˆ é™¤æœªæ ‡è®°çš„åˆ¶å“
  int32 workers = 3;                 // å·¥ä½œçº¿ç¨‹æ•°ï¼ˆå¯é€‰ï¼Œé»˜è®¤1ï¼‰
}
message TriggerGCResp {
  int64 jobId = 1;
  string message = 2;
}

//================================ä¿ç•™ç­–ç•¥ç®¡ç†================================
message RetentionRule {
  int64 id = 1;
  int32 priority = 2;
  bool disabled = 3;
  string action = 4;                 // retain
  string template = 5;               // æ¨¡æ¿ç±»å‹: latestPushedK, latestPulledN, nDaysSinceLastPull, etc.
  map<string, string> params = 6;    // æ¨¡æ¿å‚æ•°: {"latestPushedK": "10"}
  string tagSelectors = 7;           // JSON æ ¼å¼çš„æ ‡ç­¾é€‰æ‹©å™¨
  string scopeSelectors = 8;         // JSON æ ¼å¼çš„èŒƒå›´é€‰æ‹©å™¨
}

message RetentionPolicy {
  int64 id = 1;
  string algorithm = 2;              // or
  repeated RetentionRule rules = 3;
  string trigger = 4;                // JSON æ ¼å¼çš„è§¦å‘å™¨é…ç½®
  string scope = 5;                  // JSON æ ¼å¼çš„ä½œç”¨åŸŸ
  int64 createTime = 6;
  int64 updateTime = 7;
}

message RetentionExecution {
  int64 id = 1;
  int64 policyId = 2;
  string status = 3;                 // Pending, Running, Success, Failed, Stopped
  string trigger = 4;                // manual, scheduled
  int64 startTime = 5;
  int64 endTime = 6;
  int32 dryRun = 7;
}

// è·å–é¡¹ç›®ä¿ç•™ç­–ç•¥
message GetRetentionPolicyReq {
  string registryUuid = 1;
  string projectName = 2;
}
message GetRetentionPolicyResp {
  RetentionPolicy data = 1;
}

// åˆ›å»ºä¿ç•™ç­–ç•¥
message CreateRetentionPolicyReq {
  string registryUuid = 1;
  string projectName = 2;
  string algorithm = 3;
  repeated RetentionRule rules = 4;
  string schedule = 5;               // cron è¡¨è¾¾å¼ï¼ˆå¯é€‰ï¼‰
}
message CreateRetentionPolicyResp {
  int64 id = 1;
  string message = 2;
}

// æ›´æ–°ä¿ç•™ç­–ç•¥
message UpdateRetentionPolicyReq {
  string registryUuid = 1;
  int64 policyId = 2;
  string algorithm = 3;
  repeated RetentionRule rules = 4;
  string schedule = 5;
}
message UpdateRetentionPolicyResp {
  string message = 1;
}

// æ‰§è¡Œä¿ç•™ç­–ç•¥
message ExecuteRetentionPolicyReq {
  string registryUuid = 1;
  int64 policyId = 2;
  bool dryRun = 3;                   // æ˜¯å¦ä»…æ¨¡æ‹Ÿè¿è¡Œ
}
message ExecuteRetentionPolicyResp {
  int64 executionId = 1;
  string message = 2;
}

// åˆ—å‡ºä¿ç•™ç­–ç•¥æ‰§è¡Œå†å²
message ListRetentionExecutionsReq {
  string registryUuid = 1;
  int64 policyId = 2;
  int64 page = 3;
  int64 pageSize = 4;
}
message ListRetentionExecutionsResp {
  repeated RetentionExecution items = 1;
  int64 total = 2;
  int64 page = 3;
  int64 pageSize = 4;
  int64 totalPages = 5;
}

//================================å¤åˆ¶ç­–ç•¥ç®¡ç†================================
message ReplicationFilter {
  string type = 1;                   // resource, name, tag, label
  string value = 2;
  string decoration = 3;             // matches, excludes
}

message ReplicationTrigger {
  string type = 1;                   // manual, scheduled, event_based
  map<string, string> triggerSettings = 2;
}

message ReplicationPolicy {
  int64 id = 1;
  string name = 2;
  string description = 3;
  int64 srcRegistry = 4;             // æºä»“åº“ IDï¼ˆ0 è¡¨ç¤ºæœ¬åœ°ï¼‰
  int64 destRegistry = 5;            // ç›®æ ‡ä»“åº“ ID
  string destNamespace = 6;          // ç›®æ ‡å‘½åç©ºé—´
  repeated ReplicationFilter filters = 7;
  ReplicationTrigger trigger = 8;
  bool deletion = 9;                 // æ˜¯å¦åŒæ­¥åˆ é™¤
  bool override = 10;                // æ˜¯å¦è¦†ç›–
  bool enabled = 11;
  int64 creationTime = 12;
  int64 updateTime = 13;
}

message ReplicationExecution {
  int64 id = 1;
  int64 policyId = 2;
  string status = 3;                 // Pending, Running, Success, Failed, Stopped
  string trigger = 4;                // manual, scheduled, event_based
  int64 startTime = 5;
  int64 endTime = 6;
  int64 succeed = 7;                 // æˆåŠŸæ•°é‡
  int64 failed = 8;                  // å¤±è´¥æ•°é‡
  int64 inProgress = 9;              // è¿›è¡Œä¸­æ•°é‡
  int64 stopped = 10;                // åœæ­¢æ•°é‡
}

// åˆ—å‡ºå¤åˆ¶ç­–ç•¥
message ListReplicationPoliciesReq {
  string registryUuid = 1;
  string name = 2;                   // å¯é€‰ï¼šæŒ‰åç§°ç­›é€‰
  int64 page = 3;
  int64 pageSize = 4;
}
message ListReplicationPoliciesResp {
  repeated ReplicationPolicy items = 1;
  int64 total = 2;
  int64 page = 3;
  int64 pageSize = 4;
  int64 totalPages = 5;
}

// è·å–å¤åˆ¶ç­–ç•¥
message GetReplicationPolicyReq {
  string registryUuid = 1;
  int64 policyId = 2;
}
message GetReplicationPolicyResp {
  ReplicationPolicy data = 1;
}

// åˆ›å»ºå¤åˆ¶ç­–ç•¥
message CreateReplicationPolicyReq {
  string registryUuid = 1;
  string name = 2;
  string description = 3;
  int64 srcRegistry = 4;
  int64 destRegistry = 5;
  string destNamespace = 6;
  repeated ReplicationFilter filters = 7;
  ReplicationTrigger trigger = 8;
  bool deletion = 9;
  bool override = 10;
  bool enabled = 11;
}
message CreateReplicationPolicyResp {
  int64 id = 1;
  string message = 2;
}

// æ›´æ–°å¤åˆ¶ç­–ç•¥
message UpdateReplicationPolicyReq {
  string registryUuid = 1;
  int64 policyId = 2;
  string name = 3;
  string description = 4;
  int64 srcRegistry = 5;
  int64 destRegistry = 6;
  string destNamespace = 7;
  repeated ReplicationFilter filters = 8;
  ReplicationTrigger trigger = 9;
  bool deletion = 10;
  bool override = 11;
  bool enabled = 12;
}
message UpdateReplicationPolicyResp {
  string message = 1;
}

// åˆ é™¤å¤åˆ¶ç­–ç•¥
message DeleteReplicationPolicyReq {
  string registryUuid = 1;
  int64 policyId = 2;
}
message DeleteReplicationPolicyResp {
  string message = 1;
}

// æ‰§è¡Œå¤åˆ¶ç­–ç•¥
message ExecuteReplicationPolicyReq {
  string registryUuid = 1;
  int64 policyId = 2;
}
message ExecuteReplicationPolicyResp {
  int64 executionId = 1;
  string message = 2;
}

// åˆ—å‡ºå¤åˆ¶æ‰§è¡Œå†å²
message ListReplicationExecutionsReq {
  string registryUuid = 1;
  int64 policyId = 2;
  int64 page = 3;
  int64 pageSize = 4;
}
message ListReplicationExecutionsResp {
  repeated ReplicationExecution items = 1;
  int64 total = 2;
  int64 page = 3;
  int64 pageSize = 4;
  int64 totalPages = 5;
}

//================================æœåŠ¡å®šä¹‰================================
service RepositoryService {
  // ============ é•œåƒä»“åº“ç®¡ç†ï¼ˆç®¡ç†å‘˜æ“ä½œï¼‰============
  rpc CreateRegistry(CreateRegistryReq) returns (CreateRegistryResp);
  rpc UpdateRegistry(UpdateRegistryReq) returns (UpdateRegistryResp);
  rpc DeleteRegistry(DeleteRegistryReq) returns (DeleteRegistryResp);
  rpc GetRegistryByUuid(GetRegistryByUuidReq) returns (GetRegistryByUuidResp);
  rpc GetRegistryDetails(GetRegistryDetailsReq) returns (GetRegistryDetailsResp);
  rpc TestRegistryConnection(TestRegistryConnectionReq) returns (TestRegistryConnectionResp);

  // ============ ä»“åº“æŸ¥è¯¢ï¼ˆç®¡ç†å‘˜è§†è§’ + é¡¹ç›®è§†è§’ï¼‰============
  // ç®¡ç†å‘˜è§†è§’ï¼šæŸ¥è¯¢æ‰€æœ‰ä»“åº“
  rpc ListRegistries(ListRegistriesReq) returns (ListRegistriesResp);
  // é¡¹ç›®è§†è§’ï¼šæŸ¥è¯¢é¡¹ç›®å…³è”çš„ä»“åº“
  rpc ListRegistriesByProject(ListRegistriesByProjectReq) returns (ListRegistriesByProjectResp);

  // ============ ä»“åº“ä¸é›†ç¾¤å…³è”ï¼ˆç®¡ç†å‘˜æ“ä½œï¼‰============
  rpc BindRegistryToCluster(BindRegistryToClusterReq) returns (BindRegistryToClusterResp);
  rpc UnbindRegistryFromCluster(UnbindRegistryFromClusterReq) returns (UnbindRegistryFromClusterResp);
  rpc ListClusterRegistries(ListClusterRegistriesReq) returns (ListClusterRegistriesResp);
  rpc ListRegistryClusters(ListRegistryClustersReq) returns (ListRegistryClustersResp);

  // ============ ä»“åº“é¡¹ç›®ä¸åº”ç”¨é¡¹ç›®ç»‘å®šï¼ˆç®¡ç†å‘˜æ“ä½œï¼‰============
  rpc BindRegistryProject(BindRegistryProjectReq) returns (BindRegistryProjectResp);
  rpc UnbindRegistryProject(UnbindRegistryProjectReq) returns (UnbindRegistryProjectResp);
  // é€šè¿‡é•œåƒID å’Œ é¡¹ç›®åå­— æŸ¥è¯¢ ç»‘å®šçš„é¡¹ç›® ids åˆ—è¡¨ã€‚
  rpc ListProjectRegistryBindings(ListProjectRegistryBindingsReq) returns (ListProjectRegistryBindingsResp);

  // ============ ä»“åº“é¡¹ç›®æ“ä½œï¼ˆç®¡ç†å‘˜æ“ä½œ + é¡¹ç›®è§†è§’æŸ¥è¯¢ï¼‰============
  // ç®¡ç†å‘˜è§†è§’ï¼šæŸ¥è¯¢ä»“åº“æ‰€æœ‰é¡¹ç›®
  rpc ListProjects(ListProjectsReq) returns (ListProjectsResp);
  // é¡¹ç›®è§†è§’ï¼šæŸ¥è¯¢åº”ç”¨é¡¹ç›®å…³è”çš„ä»“åº“é¡¹ç›®ï¼ˆç§æœ‰é¡¹ç›®+å…¬å¼€é¡¹ç›®ï¼‰
  rpc ListProjectsByApp(ListProjectsByAppReq) returns (ListProjectsByAppResp);
  rpc GetProject(GetProjectReq) returns (GetProjectResp);
  rpc CreateProject(CreateProjectReq) returns (CreateProjectResp);
  rpc UpdateProject(UpdateProjectReq) returns (UpdateProjectResp);
  rpc DeleteProject(DeleteProjectReq) returns (DeleteProjectResp);

  // ============ ç”¨æˆ·ç®¡ç†ï¼ˆé¡¹ç›®æˆå‘˜ç®¡ç†ï¼‰============
  rpc ListProjectMembers(ListProjectMembersReq) returns (ListProjectMembersResp);
  rpc AddProjectMember(AddProjectMemberReq) returns (AddProjectMemberResp);
  rpc UpdateProjectMember(UpdateProjectMemberReq) returns (UpdateProjectMemberResp);
  rpc DeleteProjectMember(DeleteProjectMemberReq) returns (DeleteProjectMemberResp);
  rpc GetProjectMember(GetProjectMemberReq) returns (GetProjectMemberResp);

  // ============ Repository æ“ä½œ ============
  rpc ListRepositories(ListRepositoriesReq) returns (ListRepositoriesResp);
  rpc GetRepository(GetRepositoryReq) returns (GetRepositoryResp);
  rpc DeleteRepository(DeleteRepositoryReq) returns (DeleteRepositoryResp);

  // ============ åˆ¶å“/æ ‡ç­¾æ“ä½œ ============
  rpc ListArtifacts(ListArtifactsReq) returns (ListArtifactsResp);
  rpc GetArtifact(GetArtifactReq) returns (GetArtifactResp);
  rpc DeleteArtifact(DeleteArtifactReq) returns (DeleteArtifactResp);
  rpc DeleteTag(DeleteTagReq) returns (DeleteTagResp);

  // ============ é•œåƒæœç´¢ï¼ˆ4ä¸ªæ¥å£ï¼‰============
  // 1. å…¨å±€æœç´¢-ç®¡ç†å‘˜è§†è§’ï¼šæœç´¢æ‰€æœ‰ä»“åº“æ‰€æœ‰é¡¹ç›®
  rpc SearchImagesGlobal(SearchImagesGlobalReq) returns (SearchImagesGlobalResp);
  // 2. å…¨å±€æœç´¢-é¡¹ç›®è§†è§’ï¼šæœç´¢é¡¹ç›®å…³è”çš„ä»“åº“å’Œæœ‰æƒé™çš„é¡¹ç›®
  rpc SearchImagesGlobalByProject(SearchImagesGlobalByProjectReq) returns (SearchImagesGlobalByProjectResp);
  // 3. ä»“åº“å†…æœç´¢-ç®¡ç†å‘˜è§†è§’ï¼šæœç´¢æŒ‡å®šä»“åº“æ‰€æœ‰é¡¹ç›®
  rpc SearchImagesInRegistry(SearchImagesInRegistryReq) returns (SearchImagesInRegistryResp);
  // 4. ä»“åº“å†…æœç´¢-é¡¹ç›®è§†è§’ï¼šæœç´¢æŒ‡å®šä»“åº“ä¸­é¡¹ç›®å…³è”çš„é¡¹ç›®
  rpc SearchImagesInRegistryByProject(SearchImagesInRegistryByProjectReq) returns (SearchImagesInRegistryByProjectResp);

  // ============ é…é¢ç®¡ç† ============
  rpc GetProjectQuota(GetProjectQuotaReq) returns (GetProjectQuotaResp);
  rpc UpdateProjectQuota(UpdateProjectQuotaReq) returns (UpdateProjectQuotaResp);


  // ============ å…¨å±€ç”¨æˆ·ç®¡ç† ============
  rpc CreateUser(CreateUserReq) returns (CreateUserResp);
  rpc ListUsers(ListUsersReq) returns (ListUsersResp);
  rpc GetUser(GetUserReq) returns (GetUserResp);
  rpc UpdateUser(UpdateUserReq) returns (UpdateUserResp);
  rpc DeleteUser(DeleteUserReq) returns (DeleteUserResp);
  rpc ChangeUserPassword(ChangeUserPasswordReq) returns (ChangeUserPasswordResp);
  rpc SetUserAdmin(SetUserAdminReq) returns (SetUserAdminResp);


  // ============ åƒåœ¾å›æ”¶ç®¡ç† ============
  rpc ListGCHistory(ListGCHistoryReq) returns (ListGCHistoryResp);
  rpc GetGC(GetGCReq) returns (GetGCResp);
  rpc GetGCLog(GetGCLogReq) returns (GetGCLogResp);
  rpc GetGCSchedule(GetGCScheduleReq) returns (GetGCScheduleResp);
  rpc UpdateGCSchedule(UpdateGCScheduleReq) returns (UpdateGCScheduleResp);
  rpc TriggerGC(TriggerGCReq) returns (TriggerGCResp);

  // ============ ä¿ç•™ç­–ç•¥ç®¡ç† ============
  rpc GetRetentionPolicy(GetRetentionPolicyReq) returns (GetRetentionPolicyResp);
  rpc CreateRetentionPolicy(CreateRetentionPolicyReq) returns (CreateRetentionPolicyResp);
  rpc UpdateRetentionPolicy(UpdateRetentionPolicyReq) returns (UpdateRetentionPolicyResp);
  rpc ExecuteRetentionPolicy(ExecuteRetentionPolicyReq) returns (ExecuteRetentionPolicyResp);
  rpc ListRetentionExecutions(ListRetentionExecutionsReq) returns (ListRetentionExecutionsResp);

  // ============ å¤åˆ¶ç­–ç•¥ç®¡ç† ============
  rpc ListReplicationPolicies(ListReplicationPoliciesReq) returns (ListReplicationPoliciesResp);
  rpc GetReplicationPolicy(GetReplicationPolicyReq) returns (GetReplicationPolicyResp);
  rpc CreateReplicationPolicy(CreateReplicationPolicyReq) returns (CreateReplicationPolicyResp);
  rpc UpdateReplicationPolicy(UpdateReplicationPolicyReq) returns (UpdateReplicationPolicyResp);
  rpc DeleteReplicationPolicy(DeleteReplicationPolicyReq) returns (DeleteReplicationPolicyResp);
  rpc ExecuteReplicationPolicy(ExecuteReplicationPolicyReq) returns (ExecuteReplicationPolicyResp);
  rpc ListReplicationExecutions(ListReplicationExecutionsReq) returns (ListReplicationExecutionsResp);
}
