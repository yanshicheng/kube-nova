// Code generated by goctl. DO NOT EDIT.
// versions:
//  goctl version: 1.9.2

package model

import (
	"context"
	"database/sql"
	"fmt"
	"strings"
	"time"

	"github.com/zeromicro/go-zero/core/stores/builder"
	"github.com/zeromicro/go-zero/core/stores/cache"
	"github.com/zeromicro/go-zero/core/stores/sqlc"
	"github.com/zeromicro/go-zero/core/stores/sqlx"
	"github.com/zeromicro/go-zero/core/stringx"
)

var (
	onecBillingStatementFieldNames          = builder.RawFieldNames(&OnecBillingStatement{})
	onecBillingStatementRows                = strings.Join(onecBillingStatementFieldNames, ",")
	onecBillingStatementRowsExpectAutoSet   = strings.Join(stringx.Remove(onecBillingStatementFieldNames, "`id`", "`create_at`", "`create_time`", "`created_at`", "`update_at`", "`update_time`", "`updated_at`"), ",")
	onecBillingStatementRowsWithPlaceHolder = strings.Join(stringx.Remove(onecBillingStatementFieldNames, "`id`", "`create_at`", "`create_time`", "`created_at`", "`update_at`", "`update_time`", "`updated_at`"), "=?,") + "=?"

	cacheKubeNovaOnecBillingStatementIdPrefix          = "cache:kubeNova:onecBillingStatement:id:"
	cacheKubeNovaOnecBillingStatementStatementNoPrefix = "cache:kubeNova:onecBillingStatement:statementNo:"
)

type (
	onecBillingStatementModel interface {
		Insert(ctx context.Context, data *OnecBillingStatement) (sql.Result, error)
		FindOne(ctx context.Context, id uint64) (*OnecBillingStatement, error)
		FindOneByStatementNo(ctx context.Context, statementNo string) (*OnecBillingStatement, error)
		Update(ctx context.Context, data *OnecBillingStatement) error
		Delete(ctx context.Context, id uint64) error
	}

	defaultOnecBillingStatementModel struct {
		sqlc.CachedConn
		table string
	}

	OnecBillingStatement struct {
		Id                 uint64       `db:"id"`                   // 主键ID
		StatementNo        string       `db:"statement_no"`         // 账单编号
		StatementType      string       `db:"statement_type"`       // 账单类型：daily/config_change/initial
		BillingStartTime   sql.NullTime `db:"billing_start_time"`   // 计费开始时间
		BillingEndTime     sql.NullTime `db:"billing_end_time"`     // 计费结束时间
		BillingHours       float64      `db:"billing_hours"`        // 计费时长（小时）
		ClusterUuid        string       `db:"cluster_uuid"`         // 集群UUID
		ClusterName        string       `db:"cluster_name"`         // 集群名称（快照）
		ProjectId          uint64       `db:"project_id"`           // 项目ID
		ProjectName        string       `db:"project_name"`         // 项目名称（快照）
		ProjectUuid        string       `db:"project_uuid"`         // 项目UUID
		ProjectClusterId   uint64       `db:"project_cluster_id"`   // 项目集群ID
		BindingId          uint64       `db:"binding_id"`           // 计费绑定ID
		CpuCapacity        string       `db:"cpu_capacity"`         // CPU总容量
		MemCapacity        string       `db:"mem_capacity"`         // 内存总容量
		StorageLimit       string       `db:"storage_limit"`        // 存储配额（GiB）
		GpuCapacity        string       `db:"gpu_capacity"`         // GPU总容量
		PodsLimit          int64        `db:"pods_limit"`           // Pod配额
		WorkspaceCount     int64        `db:"workspace_count"`      // 工作空间数量
		ApplicationCount   int64        `db:"application_count"`    // 应用数量
		PriceCpu           float64      `db:"price_cpu"`            // CPU单价
		PriceMemory        float64      `db:"price_memory"`         // 内存单价
		PriceStorage       float64      `db:"price_storage"`        // 存储单价
		PriceGpu           float64      `db:"price_gpu"`            // GPU单价
		PricePod           float64      `db:"price_pod"`            // Pod单价
		PriceManagementFee float64      `db:"price_management_fee"` // 管理费单价
		CpuCost            float64      `db:"cpu_cost"`             // CPU费用
		MemoryCost         float64      `db:"memory_cost"`          // 内存费用
		StorageCost        float64      `db:"storage_cost"`         // 存储费用
		GpuCost            float64      `db:"gpu_cost"`             // GPU费用
		PodCost            float64      `db:"pod_cost"`             // Pod费用
		ManagementFee      float64      `db:"management_fee"`       // 管理费
		ResourceCostTotal  float64      `db:"resource_cost_total"`  // 资源费用合计
		TotalAmount        float64      `db:"total_amount"`         // 总费用
		Remark             string       `db:"remark"`               // 备注
		CreatedBy          string       `db:"created_by"`           // 创建人
		UpdatedBy          string       `db:"updated_by"`           // 更新人
		CreatedAt          time.Time    `db:"created_at"`           // 创建时间
		UpdatedAt          time.Time    `db:"updated_at"`           // 更新时间
		IsDeleted          int64        `db:"is_deleted"`           // 是否删除：0-否 1-是
	}
)

func newOnecBillingStatementModel(conn sqlx.SqlConn, c cache.CacheConf, opts ...cache.Option) *defaultOnecBillingStatementModel {
	return &defaultOnecBillingStatementModel{
		CachedConn: sqlc.NewConn(conn, c, opts...),
		table:      "`onec_billing_statement`",
	}
}

func (m *defaultOnecBillingStatementModel) Delete(ctx context.Context, id uint64) error {
	data, err := m.FindOne(ctx, id)
	if err != nil {
		return err
	}

	kubeNovaOnecBillingStatementIdKey := fmt.Sprintf("%s%v", cacheKubeNovaOnecBillingStatementIdPrefix, id)
	kubeNovaOnecBillingStatementStatementNoKey := fmt.Sprintf("%s%v", cacheKubeNovaOnecBillingStatementStatementNoPrefix, data.StatementNo)
	_, err = m.ExecCtx(ctx, func(ctx context.Context, conn sqlx.SqlConn) (result sql.Result, err error) {
		query := fmt.Sprintf("delete from %s where `id` = ?", m.table)
		return conn.ExecCtx(ctx, query, id)
	}, kubeNovaOnecBillingStatementIdKey, kubeNovaOnecBillingStatementStatementNoKey)
	return err
}

func (m *defaultOnecBillingStatementModel) FindOne(ctx context.Context, id uint64) (*OnecBillingStatement, error) {
	kubeNovaOnecBillingStatementIdKey := fmt.Sprintf("%s%v", cacheKubeNovaOnecBillingStatementIdPrefix, id)
	var resp OnecBillingStatement
	err := m.QueryRowCtx(ctx, &resp, kubeNovaOnecBillingStatementIdKey, func(ctx context.Context, conn sqlx.SqlConn, v any) error {
		query := fmt.Sprintf("select %s from %s where `id` = ? limit 1", onecBillingStatementRows, m.table)
		return conn.QueryRowCtx(ctx, v, query, id)
	})
	switch err {
	case nil:
		return &resp, nil
	case sqlc.ErrNotFound:
		return nil, ErrNotFound
	default:
		return nil, err
	}
}

func (m *defaultOnecBillingStatementModel) FindOneByStatementNo(ctx context.Context, statementNo string) (*OnecBillingStatement, error) {
	kubeNovaOnecBillingStatementStatementNoKey := fmt.Sprintf("%s%v", cacheKubeNovaOnecBillingStatementStatementNoPrefix, statementNo)
	var resp OnecBillingStatement
	err := m.QueryRowIndexCtx(ctx, &resp, kubeNovaOnecBillingStatementStatementNoKey, m.formatPrimary, func(ctx context.Context, conn sqlx.SqlConn, v any) (i any, e error) {
		query := fmt.Sprintf("select %s from %s where `statement_no` = ? limit 1", onecBillingStatementRows, m.table)
		if err := conn.QueryRowCtx(ctx, &resp, query, statementNo); err != nil {
			return nil, err
		}
		return resp.Id, nil
	}, m.queryPrimary)
	switch err {
	case nil:
		return &resp, nil
	case sqlc.ErrNotFound:
		return nil, ErrNotFound
	default:
		return nil, err
	}
}

func (m *defaultOnecBillingStatementModel) Insert(ctx context.Context, data *OnecBillingStatement) (sql.Result, error) {
	kubeNovaOnecBillingStatementIdKey := fmt.Sprintf("%s%v", cacheKubeNovaOnecBillingStatementIdPrefix, data.Id)
	kubeNovaOnecBillingStatementStatementNoKey := fmt.Sprintf("%s%v", cacheKubeNovaOnecBillingStatementStatementNoPrefix, data.StatementNo)
	ret, err := m.ExecCtx(ctx, func(ctx context.Context, conn sqlx.SqlConn) (result sql.Result, err error) {
		query := fmt.Sprintf("insert into %s (%s) values (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)", m.table, onecBillingStatementRowsExpectAutoSet)
		return conn.ExecCtx(ctx, query, data.StatementNo, data.StatementType, data.BillingStartTime, data.BillingEndTime, data.BillingHours, data.ClusterUuid, data.ClusterName, data.ProjectId, data.ProjectName, data.ProjectUuid, data.ProjectClusterId, data.BindingId, data.CpuCapacity, data.MemCapacity, data.StorageLimit, data.GpuCapacity, data.PodsLimit, data.WorkspaceCount, data.ApplicationCount, data.PriceCpu, data.PriceMemory, data.PriceStorage, data.PriceGpu, data.PricePod, data.PriceManagementFee, data.CpuCost, data.MemoryCost, data.StorageCost, data.GpuCost, data.PodCost, data.ManagementFee, data.ResourceCostTotal, data.TotalAmount, data.Remark, data.CreatedBy, data.UpdatedBy, data.IsDeleted)
	}, kubeNovaOnecBillingStatementIdKey, kubeNovaOnecBillingStatementStatementNoKey)
	return ret, err
}

func (m *defaultOnecBillingStatementModel) Update(ctx context.Context, newData *OnecBillingStatement) error {
	data, err := m.FindOne(ctx, newData.Id)
	if err != nil {
		return err
	}

	kubeNovaOnecBillingStatementIdKey := fmt.Sprintf("%s%v", cacheKubeNovaOnecBillingStatementIdPrefix, data.Id)
	kubeNovaOnecBillingStatementStatementNoKey := fmt.Sprintf("%s%v", cacheKubeNovaOnecBillingStatementStatementNoPrefix, data.StatementNo)
	_, err = m.ExecCtx(ctx, func(ctx context.Context, conn sqlx.SqlConn) (result sql.Result, err error) {
		query := fmt.Sprintf("update %s set %s where `id` = ?", m.table, onecBillingStatementRowsWithPlaceHolder)
		return conn.ExecCtx(ctx, query, newData.StatementNo, newData.StatementType, newData.BillingStartTime, newData.BillingEndTime, newData.BillingHours, newData.ClusterUuid, newData.ClusterName, newData.ProjectId, newData.ProjectName, newData.ProjectUuid, newData.ProjectClusterId, newData.BindingId, newData.CpuCapacity, newData.MemCapacity, newData.StorageLimit, newData.GpuCapacity, newData.PodsLimit, newData.WorkspaceCount, newData.ApplicationCount, newData.PriceCpu, newData.PriceMemory, newData.PriceStorage, newData.PriceGpu, newData.PricePod, newData.PriceManagementFee, newData.CpuCost, newData.MemoryCost, newData.StorageCost, newData.GpuCost, newData.PodCost, newData.ManagementFee, newData.ResourceCostTotal, newData.TotalAmount, newData.Remark, newData.CreatedBy, newData.UpdatedBy, newData.IsDeleted, newData.Id)
	}, kubeNovaOnecBillingStatementIdKey, kubeNovaOnecBillingStatementStatementNoKey)
	return err
}

func (m *defaultOnecBillingStatementModel) formatPrimary(primary any) string {
	return fmt.Sprintf("%s%v", cacheKubeNovaOnecBillingStatementIdPrefix, primary)
}

func (m *defaultOnecBillingStatementModel) queryPrimary(ctx context.Context, conn sqlx.SqlConn, v, primary any) error {
	query := fmt.Sprintf("select %s from %s where `id` = ? limit 1", onecBillingStatementRows, m.table)
	return conn.QueryRowCtx(ctx, v, query, primary)
}

func (m *defaultOnecBillingStatementModel) tableName() string {
	return m.table
}
