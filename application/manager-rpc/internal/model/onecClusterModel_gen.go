// Code generated by goctl. DO NOT EDIT.
// versions:
//  goctl version: 1.7.3

package model

import (
	"context"
	"database/sql"
	"fmt"
	"strings"
	"time"

	"github.com/zeromicro/go-zero/core/stores/builder"
	"github.com/zeromicro/go-zero/core/stores/cache"
	"github.com/zeromicro/go-zero/core/stores/sqlc"
	"github.com/zeromicro/go-zero/core/stores/sqlx"
	"github.com/zeromicro/go-zero/core/stringx"
)

var (
	onecClusterFieldNames          = builder.RawFieldNames(&OnecCluster{})
	onecClusterRows                = strings.Join(onecClusterFieldNames, ",")
	onecClusterRowsExpectAutoSet   = strings.Join(stringx.Remove(onecClusterFieldNames, "`id`", "`create_at`", "`create_time`", "`created_at`", "`update_at`", "`update_time`", "`updated_at`"), ",")
	onecClusterRowsWithPlaceHolder = strings.Join(stringx.Remove(onecClusterFieldNames, "`id`", "`create_at`", "`create_time`", "`created_at`", "`update_at`", "`update_time`", "`updated_at`"), "=?,") + "=?"

	cacheIkubeopsOnecClusterIdPrefix   = "cache:ikubeops:onecCluster:id:"
	cacheIkubeopsOnecClusterNamePrefix = "cache:ikubeops:onecCluster:name:"
	cacheIkubeopsOnecClusterUuidPrefix = "cache:ikubeops:onecCluster:uuid:"
)

type (
	onecClusterModel interface {
		Insert(ctx context.Context, data *OnecCluster) (sql.Result, error)

		FindOne(ctx context.Context, id uint64) (*OnecCluster, error)
		Search(ctx context.Context, orderStr string, isAsc bool, page, pageSize uint64, queryStr string, args ...any) ([]*OnecCluster, uint64, error)
		SearchNoPage(ctx context.Context, orderStr string, isAsc bool, queryStr string, args ...any) ([]*OnecCluster, error)
		FindOneByName(ctx context.Context, name string) (*OnecCluster, error)
		FindOneByUuid(ctx context.Context, uuid string) (*OnecCluster, error)
		Update(ctx context.Context, data *OnecCluster) error
		Delete(ctx context.Context, id uint64) error
		DeleteSoft(ctx context.Context, id uint64) error
		TransCtx(ctx context.Context, fn func(context.Context, sqlx.Session) error) error
		TransOnSql(ctx context.Context, session sqlx.Session, id uint64, sqlStr string, args ...any) (sql.Result, error)
		ExecSql(ctx context.Context, id uint64, sqlStr string, args ...any) (sql.Result, error)
	}

	defaultOnecClusterModel struct {
		sqlc.CachedConn
		table string
	}

	OnecCluster struct {
		Id               uint64    `db:"id"`                 // 自增主键
		Name             string    `db:"name"`               // 集群名称，全局唯一
		Avatar           string    `db:"avatar"`             // 头像URL
		Uuid             string    `db:"uuid"`               // 集群唯一标识UUID
		Description      string    `db:"description"`        // 集群描述信息
		ClusterType      string    `db:"cluster_type"`       // 集群类型: standard(标准)/edge(边缘)/serverless(无服务器)
		Environment      string    `db:"environment"`        // 环境类型: development(开发)/testing(测试)/staging(预发布)/production(生产)
		Region           string    `db:"region"`             // 地域信息，如cn-north-1/us-east-1
		Zone             string    `db:"zone"`               // 可用区信息，如cn-north-1a
		Datacenter       string    `db:"datacenter"`         // 数据中心名称
		Provider         string    `db:"provider"`           // 云提供商: aws/azure/gcp/alibaba/tencent/huawei/self-hosted(自建)
		IsManaged        int64     `db:"is_managed"`         // 是否为云厂商托管集群，如EKS/AKS/GKE
		NodeLb           string    `db:"node_lb"`            // Node负载均衡IP地址 支持ipv6 和 ipv4 多个 逗号分隔
		MasterLb         string    `db:"master_lb"`          // Master负载均衡IP地址 支持ipv6 和 ipv4 多个 逗号分隔
		IngressDomain    string    `db:"ingress_domain"`     // Ingress 域名前缀地址，比如 ikubeops.com 多个逗号分隔
		Status           int64     `db:"status"`             // 集群状态: 1: 同步中 2: 同步异常 3. 同步正常
		HealthStatus     int64     `db:"health_status"`      // 健康状态: 1 healthy(健康)/2 unhealthy(不健康)/3 degraded(降级)/4 unknown(未知)
		LastSyncAt       time.Time `db:"last_sync_at"`       // 最后同步时间
		Version          string    `db:"version"`            // Kubernetes版本，如v1.28.0
		GitCommit        string    `db:"git_commit"`         // Kubernetes Git提交版本
		Platform         string    `db:"platform"`           // 集群平台，如linux/amd64
		VersionBuildAt   time.Time `db:"version_build_at"`   // Kubernetes版本构建时间
		ClusterCreatedAt time.Time `db:"cluster_created_at"` // 集群创建时间
		CostCenter       string    `db:"cost_center"`        // 成本中心编码
		BusinessUnit     string    `db:"business_unit"`      // 业务单元名称
		OwnerTeam        string    `db:"owner_team"`         // 负责团队名称
		OwnerEmail       string    `db:"owner_email"`        // 负责人邮箱
		Priority         int64     `db:"priority"`           // 集群优先级，数字越大优先级越高
		CreatedBy        string    `db:"created_by"`         // 记录创建人
		UpdatedBy        string    `db:"updated_by"`         // 记录最后更新人
		CreatedAt        time.Time `db:"created_at"`         // 记录创建时间
		UpdatedAt        time.Time `db:"updated_at"`         // 记录更新时间
		IsDeleted        int64     `db:"is_deleted"`         // 是否已删除，软删除标记
	}
)

func newOnecClusterModel(conn sqlx.SqlConn, c cache.CacheConf, opts ...cache.Option) *defaultOnecClusterModel {
	return &defaultOnecClusterModel{
		CachedConn: sqlc.NewConn(conn, c, opts...),
		table:      "`onec_cluster`",
	}
}

func (m *defaultOnecClusterModel) Delete(ctx context.Context, id uint64) error {
	data, err := m.FindOne(ctx, id)
	if err != nil {
		return err
	}

	ikubeopsOnecClusterIdKey := fmt.Sprintf("%s%v", cacheIkubeopsOnecClusterIdPrefix, id)
	ikubeopsOnecClusterNameKey := fmt.Sprintf("%s%v", cacheIkubeopsOnecClusterNamePrefix, data.Name)
	ikubeopsOnecClusterUuidKey := fmt.Sprintf("%s%v", cacheIkubeopsOnecClusterUuidPrefix, data.Uuid)
	_, err = m.ExecCtx(ctx, func(ctx context.Context, conn sqlx.SqlConn) (result sql.Result, err error) {
		query := fmt.Sprintf("delete from %s where `id` = ?", m.table)
		return conn.ExecCtx(ctx, query, id)
	}, ikubeopsOnecClusterIdKey, ikubeopsOnecClusterNameKey, ikubeopsOnecClusterUuidKey)
	return err
}

func (m *defaultOnecClusterModel) DeleteSoft(ctx context.Context, id uint64) error {
	data, err := m.FindOne(ctx, id)
	if err != nil {
		return err
	}
	// 如果记录已软删除，无需再次删除
	if data.IsDeleted == 1 {
		return nil
	}
	ikubeopsOnecClusterIdKey := fmt.Sprintf("%s%v", cacheIkubeopsOnecClusterIdPrefix, id)
	ikubeopsOnecClusterNameKey := fmt.Sprintf("%s%v", cacheIkubeopsOnecClusterNamePrefix, data.Name)
	ikubeopsOnecClusterUuidKey := fmt.Sprintf("%s%v", cacheIkubeopsOnecClusterUuidPrefix, data.Uuid)
	_, err = m.ExecCtx(ctx, func(ctx context.Context, conn sqlx.SqlConn) (result sql.Result, err error) {
		query := fmt.Sprintf("update %s set `is_deleted` = 1 where `id` = ?", m.table)
		return conn.ExecCtx(ctx, query, id)
	}, ikubeopsOnecClusterIdKey, ikubeopsOnecClusterNameKey, ikubeopsOnecClusterUuidKey)
	return err
}

func (m *defaultOnecClusterModel) TransCtx(ctx context.Context, fn func(context.Context, sqlx.Session) error) error {
	return m.TransactCtx(ctx, func(ctx context.Context, session sqlx.Session) error {
		return fn(ctx, session)
	})
}

func (m *defaultOnecClusterModel) TransOnSql(ctx context.Context, session sqlx.Session, id uint64, sqlStr string, args ...any) (sql.Result, error) {
	query := strings.ReplaceAll(sqlStr, "{table}", m.table)
	// 如果 id != 0 并且启用了缓存逻辑
	if !isZeroValue(id) {
		// 查询数据（如果需要，确保数据存在）
		data, err := m.FindOne(ctx, id)
		if err != nil {
			return nil, err
		}

		// 缓存相关处理

		ikubeopsOnecClusterIdKey := fmt.Sprintf("%s%v", cacheIkubeopsOnecClusterIdPrefix, id)
		ikubeopsOnecClusterNameKey := fmt.Sprintf("%s%v", cacheIkubeopsOnecClusterNamePrefix, data.Name)
		ikubeopsOnecClusterUuidKey := fmt.Sprintf("%s%v", cacheIkubeopsOnecClusterUuidPrefix, data.Uuid) // 处理缓存逻辑，例如删除或更新缓存
		// 执行带缓存处理的 SQL 操作
		return m.ExecCtx(ctx, func(ctx context.Context, conn sqlx.SqlConn) (sql.Result, error) {
			return session.ExecCtx(ctx, query, args...)
		}, ikubeopsOnecClusterIdKey, ikubeopsOnecClusterNameKey, ikubeopsOnecClusterUuidKey) // 传递缓存相关的键值

	}

	// 如果 id == 0 或不需要缓存，直接执行 SQL
	return m.ExecCtx(ctx, func(ctx context.Context, conn sqlx.SqlConn) (sql.Result, error) {
		return session.ExecCtx(ctx, query, args...)
	})
}

func (m *defaultOnecClusterModel) ExecSql(ctx context.Context, id uint64, sqlStr string, args ...any) (sql.Result, error) {
	// 如果 id != 0 并且启用了缓存逻辑
	query := strings.ReplaceAll(sqlStr, "{table}", m.table)
	if !isZeroValue(id) {
		// 缓存相关处理

		// 查询数据（如果需要，确保数据存在）
		data, err := m.FindOne(ctx, id)
		if err != nil {
			return nil, err
		}

		ikubeopsOnecClusterIdKey := fmt.Sprintf("%s%v", cacheIkubeopsOnecClusterIdPrefix, id)
		ikubeopsOnecClusterNameKey := fmt.Sprintf("%s%v", cacheIkubeopsOnecClusterNamePrefix, data.Name)
		ikubeopsOnecClusterUuidKey := fmt.Sprintf("%s%v", cacheIkubeopsOnecClusterUuidPrefix, data.Uuid) // 处理缓存逻辑，例如删除或更新缓存
		// 执行带缓存处理的 SQL 操作
		return m.ExecCtx(ctx, func(ctx context.Context, conn sqlx.SqlConn) (sql.Result, error) {
			return conn.ExecCtx(ctx, query, args...)
		}, ikubeopsOnecClusterIdKey, ikubeopsOnecClusterNameKey, ikubeopsOnecClusterUuidKey) // 传递缓存相关的键值

	}

	// 如果 id == 0 或不需要缓存，直接执行 SQL
	return m.ExecCtx(ctx, func(ctx context.Context, conn sqlx.SqlConn) (sql.Result, error) {
		return conn.ExecCtx(ctx, query, args...)
	})
}
func (m *defaultOnecClusterModel) FindOne(ctx context.Context, id uint64) (*OnecCluster, error) {
	ikubeopsOnecClusterIdKey := fmt.Sprintf("%s%v", cacheIkubeopsOnecClusterIdPrefix, id)
	var resp OnecCluster
	err := m.QueryRowCtx(ctx, &resp, ikubeopsOnecClusterIdKey, func(ctx context.Context, conn sqlx.SqlConn, v any) error {
		query := fmt.Sprintf("select %s from %s where `id` = ? AND `is_deleted` = 0 limit 1", onecClusterRows, m.table)
		return conn.QueryRowCtx(ctx, v, query, id)
	})
	switch err {
	case nil:
		return &resp, nil
	case sqlc.ErrNotFound:
		return nil, ErrNotFound
	default:
		return nil, err
	}
}

func (m *defaultOnecClusterModel) Search(ctx context.Context, orderStr string, isAsc bool, page, pageSize uint64, queryStr string, args ...any) ([]*OnecCluster, uint64, error) {
	// 确保分页参数有效
	if page < 1 {
		page = 1
	}
	if pageSize < 1 {
		pageSize = 20
	}

	// 构造查询条件
	// 添加 `is_deleted` = 0 条件，保证只查询未软删除数据
	// 初始化 WHERE 子句
	where := "WHERE `is_deleted` = 0"
	if queryStr != "" {
		where = fmt.Sprintf("WHERE %s AND `is_deleted` = 0", queryStr)
	}

	// 根据 isAsc 参数确定排序方式
	sortDirection := "ASC"
	if !isAsc {
		sortDirection = "DESC"
	}

	// 如果用户未指定排序字段，则默认使用 id
	if orderStr == "" {
		orderStr = fmt.Sprintf("ORDER BY id %s", sortDirection)
	} else {
		orderStr = strings.TrimSpace(orderStr)
		if !strings.HasPrefix(strings.ToUpper(orderStr), "ORDER BY") {
			orderStr = "ORDER BY " + orderStr
		}
		orderStr = fmt.Sprintf("%s %s", orderStr, sortDirection)
	}

	countQuery := fmt.Sprintf("SELECT COUNT(1) FROM %s %s", m.table, where)

	var total uint64
	var resp []*OnecCluster
	err := m.QueryRowNoCacheCtx(ctx, &total, countQuery, args...)
	if err != nil {
		return nil, 0, err
	}
	if total == 0 {
		// 无匹配记录
		return resp, 0, ErrNotFound
	}
	offset := (page - 1) * pageSize
	dataQuery := fmt.Sprintf("SELECT %s FROM %s %s %s LIMIT %d,%d", onecClusterRows, m.table, where, orderStr, offset, pageSize)

	err = m.QueryRowsNoCacheCtx(ctx, &resp, dataQuery, args...)
	if err != nil {
		return nil, 0, err
	}

	return resp, total, nil
}

func (m *defaultOnecClusterModel) SearchNoPage(ctx context.Context, orderStr string, isAsc bool, queryStr string, args ...any) ([]*OnecCluster, error) {
	// 处理 nil 参数
	if args == nil {
		args = []any{}
	}
	// 初始化 WHERE 子句
	where := "WHERE `is_deleted` = 0"
	// 处理查询条件和参数
	var finalArgs []any
	if queryStr != "" {
		where = fmt.Sprintf("WHERE %s AND `is_deleted` = 0", queryStr)
		// 只有当有查询条件时才使用参数
		if len(args) > 0 {
			finalArgs = args
		}
	}

	// 根据 isAsc 参数确定排序方式
	sortDirection := "ASC"
	if !isAsc {
		sortDirection = "DESC"
	}
	// 如果用户未指定排序字段，则默认使用 id
	if orderStr == "" {
		orderStr = fmt.Sprintf("ORDER BY id %s", sortDirection)
	} else {
		orderStr = strings.TrimSpace(orderStr)
		if !strings.HasPrefix(strings.ToUpper(orderStr), "ORDER BY") {
			orderStr = "ORDER BY " + orderStr
		}
		orderStr = fmt.Sprintf("%s %s", orderStr, sortDirection)
	}
	dataQuery := fmt.Sprintf("SELECT %s FROM %s %s %s", onecClusterRows, m.table, where, orderStr)
	var resp []*OnecCluster
	// 根据是否有参数来调用
	var err error
	if len(finalArgs) > 0 {
		err = m.QueryRowsNoCacheCtx(ctx, &resp, dataQuery, finalArgs...)
	} else {
		err = m.QueryRowsNoCacheCtx(ctx, &resp, dataQuery)
	}
	switch err {
	case nil:
		return resp, nil
	case sqlx.ErrNotFound:
		return nil, ErrNotFound
	default:
		return nil, err
	}
}
func (m *defaultOnecClusterModel) FindOneByName(ctx context.Context, name string) (*OnecCluster, error) {
	ikubeopsOnecClusterNameKey := fmt.Sprintf("%s%v", cacheIkubeopsOnecClusterNamePrefix, name)
	var resp OnecCluster
	err := m.QueryRowIndexCtx(ctx, &resp, ikubeopsOnecClusterNameKey, m.formatPrimary, func(ctx context.Context, conn sqlx.SqlConn, v any) (i any, e error) {
		query := fmt.Sprintf("select %s from %s where `name` = ? AND `is_deleted` = 0  limit 1", onecClusterRows, m.table)
		if err := conn.QueryRowCtx(ctx, &resp, query, name); err != nil {
			return nil, err
		}
		return resp.Id, nil
	}, m.queryPrimary)
	switch err {
	case nil:
		return &resp, nil
	case sqlc.ErrNotFound:
		return nil, ErrNotFound
	default:
		return nil, err
	}
}

func (m *defaultOnecClusterModel) FindOneByUuid(ctx context.Context, uuid string) (*OnecCluster, error) {
	ikubeopsOnecClusterUuidKey := fmt.Sprintf("%s%v", cacheIkubeopsOnecClusterUuidPrefix, uuid)
	var resp OnecCluster
	err := m.QueryRowIndexCtx(ctx, &resp, ikubeopsOnecClusterUuidKey, m.formatPrimary, func(ctx context.Context, conn sqlx.SqlConn, v any) (i any, e error) {
		query := fmt.Sprintf("select %s from %s where `uuid` = ? AND `is_deleted` = 0  limit 1", onecClusterRows, m.table)
		if err := conn.QueryRowCtx(ctx, &resp, query, uuid); err != nil {
			return nil, err
		}
		return resp.Id, nil
	}, m.queryPrimary)
	switch err {
	case nil:
		return &resp, nil
	case sqlc.ErrNotFound:
		return nil, ErrNotFound
	default:
		return nil, err
	}
}

func (m *defaultOnecClusterModel) Insert(ctx context.Context, data *OnecCluster) (sql.Result, error) {
	ikubeopsOnecClusterIdKey := fmt.Sprintf("%s%v", cacheIkubeopsOnecClusterIdPrefix, data.Id)
	ikubeopsOnecClusterNameKey := fmt.Sprintf("%s%v", cacheIkubeopsOnecClusterNamePrefix, data.Name)
	ikubeopsOnecClusterUuidKey := fmt.Sprintf("%s%v", cacheIkubeopsOnecClusterUuidPrefix, data.Uuid)
	ret, err := m.ExecCtx(ctx, func(ctx context.Context, conn sqlx.SqlConn) (result sql.Result, err error) {
		query := fmt.Sprintf("insert into %s (%s) values (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)", m.table, onecClusterRowsExpectAutoSet)
		return conn.ExecCtx(ctx, query, data.Name, data.Avatar, data.Uuid, data.Description, data.ClusterType, data.Environment, data.Region, data.Zone, data.Datacenter, data.Provider, data.IsManaged, data.NodeLb, data.MasterLb, data.IngressDomain, data.Status, data.HealthStatus, data.LastSyncAt, data.Version, data.GitCommit, data.Platform, data.VersionBuildAt, data.ClusterCreatedAt, data.CostCenter, data.BusinessUnit, data.OwnerTeam, data.OwnerEmail, data.Priority, data.CreatedBy, data.UpdatedBy, data.IsDeleted)
	}, ikubeopsOnecClusterIdKey, ikubeopsOnecClusterNameKey, ikubeopsOnecClusterUuidKey)
	return ret, err
}

func (m *defaultOnecClusterModel) Update(ctx context.Context, newData *OnecCluster) error {
	data, err := m.FindOne(ctx, newData.Id)
	if err != nil {
		return err
	}

	ikubeopsOnecClusterIdKey := fmt.Sprintf("%s%v", cacheIkubeopsOnecClusterIdPrefix, data.Id)
	ikubeopsOnecClusterNameKey := fmt.Sprintf("%s%v", cacheIkubeopsOnecClusterNamePrefix, data.Name)
	ikubeopsOnecClusterUuidKey := fmt.Sprintf("%s%v", cacheIkubeopsOnecClusterUuidPrefix, data.Uuid)
	_, err = m.ExecCtx(ctx, func(ctx context.Context, conn sqlx.SqlConn) (result sql.Result, err error) {
		query := fmt.Sprintf("update %s set %s where `id` = ?", m.table, onecClusterRowsWithPlaceHolder)
		return conn.ExecCtx(ctx, query, newData.Name, newData.Avatar, newData.Uuid, newData.Description, newData.ClusterType, newData.Environment, newData.Region, newData.Zone, newData.Datacenter, newData.Provider, newData.IsManaged, newData.NodeLb, newData.MasterLb, newData.IngressDomain, newData.Status, newData.HealthStatus, newData.LastSyncAt, newData.Version, newData.GitCommit, newData.Platform, newData.VersionBuildAt, newData.ClusterCreatedAt, newData.CostCenter, newData.BusinessUnit, newData.OwnerTeam, newData.OwnerEmail, newData.Priority, newData.CreatedBy, newData.UpdatedBy, newData.IsDeleted, newData.Id)
	}, ikubeopsOnecClusterIdKey, ikubeopsOnecClusterNameKey, ikubeopsOnecClusterUuidKey)
	return err
}

func (m *defaultOnecClusterModel) formatPrimary(primary any) string {
	return fmt.Sprintf("%s%v", cacheIkubeopsOnecClusterIdPrefix, primary)
}

func (m *defaultOnecClusterModel) queryPrimary(ctx context.Context, conn sqlx.SqlConn, v, primary any) error {
	query := fmt.Sprintf("select %s from %s where `id` = ? AND `is_deleted` = 0 limit 1", onecClusterRows, m.table)
	return conn.QueryRowCtx(ctx, v, query, primary)
}

func (m *defaultOnecClusterModel) tableName() string {
	return m.table
}
