package model

import (
	"context"
	"database/sql"
	"fmt"

	"github.com/yanshicheng/kube-onec/common/utils"
	"github.com/zeromicro/go-zero/core/stores/cache"
	"github.com/zeromicro/go-zero/core/stores/sqlx"
)

var _ OnecProjectClusterModel = (*customOnecProjectClusterModel)(nil)

// WorkspaceResourceStats 工作空间资源统计结构体
type WorkspaceResourceStats struct {
	CpuAllocated              float64 `json:"cpu_allocated"`               // CPU已分配总量（核）
	MemAllocated              float64 `json:"mem_allocated"`               // 内存已分配总量（GiB）
	StorageAllocated          float64 `json:"storage_allocated"`           // 存储已分配总量（GiB）
	GpuAllocated              float64 `json:"gpu_allocated"`               // GPU已分配总量（个）
	PodsAllocated             int64   `json:"pods_allocated"`              // Pod已分配总量
	ConfigmapAllocated        int64   `json:"configmap_allocated"`         // ConfigMap已分配总量
	SecretAllocated           int64   `json:"secret_allocated"`            // Secret已分配总量
	PvcAllocated              int64   `json:"pvc_allocated"`               // PVC已分配总量
	EphemeralStorageAllocated float64 `json:"ephemeral_storage_allocated"` // 临时存储已分配总量（GiB）
	ServiceAllocated          int64   `json:"service_allocated"`           // Service已分配总量
	LoadbalancersAllocated    int64   `json:"loadbalancers_allocated"`     // LoadBalancer已分配总量
	NodeportsAllocated        int64   `json:"nodeports_allocated"`         // NodePort已分配总量
	DeploymentsAllocated      int64   `json:"deployments_allocated"`       // Deployment已分配总量
	JobsAllocated             int64   `json:"jobs_allocated"`              // Job已分配总量
	CronjobsAllocated         int64   `json:"cronjobs_allocated"`          // CronJob已分配总量
	DaemonsetsAllocated       int64   `json:"daemonsets_allocated"`        // DaemonSet已分配总量
	StatefulsetsAllocated     int64   `json:"statefulsets_allocated"`      // StatefulSet已分配总量
	IngressesAllocated        int64   `json:"ingresses_allocated"`         // Ingress已分配总量
}

type (
	OnecProjectClusterModel interface {
		onecProjectClusterModel
		// GetWorkspaceResourceStats 获取指定项目集群下所有工作空间的资源分配统计
		GetWorkspaceResourceStats(ctx context.Context, projectClusterId uint64) (*WorkspaceResourceStats, error)
		// SyncResourceAllocation 同步工作空间资源分配到项目集群表
		SyncResourceAllocation(ctx context.Context, projectClusterId uint64) error
	}

	customOnecProjectClusterModel struct {
		*defaultOnecProjectClusterModel
	}
)

// NewOnecProjectClusterModel returns a model for the database table.
func NewOnecProjectClusterModel(conn sqlx.SqlConn, c cache.CacheConf, opts ...cache.Option) OnecProjectClusterModel {
	return &customOnecProjectClusterModel{
		defaultOnecProjectClusterModel: newOnecProjectClusterModel(conn, c, opts...),
	}
}

// GetWorkspaceResourceStats 获取指定项目集群下所有工作空间的资源分配统计
// 由于工作空间表的资源字段是VARCHAR字符串类型，需要在Go代码中进行转换和累加
func (m *customOnecProjectClusterModel) GetWorkspaceResourceStats(ctx context.Context, projectClusterId uint64) (*WorkspaceResourceStats, error) {
	// 查询该项目集群下所有未删除的工作空间
	query := `
		SELECT 
			cpu_allocated,
			mem_allocated,
			storage_allocated,
			gpu_allocated,
			pods_allocated,
			configmap_allocated,
			secret_allocated,
			pvc_allocated,
			ephemeral_storage_allocated,
			service_allocated,
			loadbalancers_allocated,
			nodeports_allocated,
			deployments_allocated,
			jobs_allocated,
			cronjobs_allocated,
			daemonsets_allocated,
			statefulsets_allocated,
			ingresses_allocated
		FROM onec_project_workspace
		WHERE project_cluster_id = ? AND is_deleted = 0
	`

	// 定义工作空间记录结构体（字符串类型）
	type WorkspaceRecord struct {
		CpuAllocated              string `db:"cpu_allocated"`
		MemAllocated              string `db:"mem_allocated"`
		StorageAllocated          string `db:"storage_allocated"`
		GpuAllocated              string `db:"gpu_allocated"`
		PodsAllocated             int64  `db:"pods_allocated"`
		ConfigmapAllocated        int64  `db:"configmap_allocated"`
		SecretAllocated           int64  `db:"secret_allocated"`
		PvcAllocated              int64  `db:"pvc_allocated"`
		EphemeralStorageAllocated string `db:"ephemeral_storage_allocated"`
		ServiceAllocated          int64  `db:"service_allocated"`
		LoadbalancersAllocated    int64  `db:"loadbalancers_allocated"`
		NodeportsAllocated        int64  `db:"nodeports_allocated"`
		DeploymentsAllocated      int64  `db:"deployments_allocated"`
		JobsAllocated             int64  `db:"jobs_allocated"`
		CronjobsAllocated         int64  `db:"cronjobs_allocated"`
		DaemonsetsAllocated       int64  `db:"daemonsets_allocated"`
		StatefulsetsAllocated     int64  `db:"statefulsets_allocated"`
		IngressesAllocated        int64  `db:"ingresses_allocated"`
	}

	var workspaces []*WorkspaceRecord
	err := m.QueryRowsNoCacheCtx(ctx, &workspaces, query, projectClusterId)
	if err != nil && err != sqlx.ErrNotFound {
		return nil, fmt.Errorf("查询工作空间列表失败: %v", err)
	}

	// 初始化统计结果
	stats := &WorkspaceResourceStats{}

	// 如果没有工作空间，直接返回零值统计
	if len(workspaces) == 0 {
		return stats, nil
	}

	// 遍历所有工作空间，累加资源
	for _, ws := range workspaces {
		// 转换并累加 CPU（核心数）
		cpu, err := utils.CPUToCores(ws.CpuAllocated)
		if err != nil {
			return nil, fmt.Errorf("CPU转换失败 [%s]: %v", ws.CpuAllocated, err)
		}
		stats.CpuAllocated += cpu

		// 转换并累加内存（GiB）
		mem, err := utils.MemoryToGiB(ws.MemAllocated)
		if err != nil {
			return nil, fmt.Errorf("内存转换失败 [%s]: %v", ws.MemAllocated, err)
		}
		stats.MemAllocated += mem

		// 转换并累加存储（GiB）
		storage, err := utils.MemoryToGiB(ws.StorageAllocated)
		if err != nil {
			return nil, fmt.Errorf("存储转换失败 [%s]: %v", ws.StorageAllocated, err)
		}
		stats.StorageAllocated += storage

		// 转换并累加 GPU（个数）
		gpu, err := utils.GPUToCount(ws.GpuAllocated)
		if err != nil {
			return nil, fmt.Errorf("GPU转换失败 [%s]: %v", ws.GpuAllocated, err)
		}
		stats.GpuAllocated += gpu

		// 转换并累加临时存储（GiB）
		ephStorage, err := utils.MemoryToGiB(ws.EphemeralStorageAllocated)
		if err != nil {
			return nil, fmt.Errorf("临时存储转换失败 [%s]: %v", ws.EphemeralStorageAllocated, err)
		}
		stats.EphemeralStorageAllocated += ephStorage

		// 累加整数类型的资源（不需要转换）
		stats.PodsAllocated += ws.PodsAllocated
		stats.ConfigmapAllocated += ws.ConfigmapAllocated
		stats.SecretAllocated += ws.SecretAllocated
		stats.PvcAllocated += ws.PvcAllocated
		stats.ServiceAllocated += ws.ServiceAllocated
		stats.LoadbalancersAllocated += ws.LoadbalancersAllocated
		stats.NodeportsAllocated += ws.NodeportsAllocated
		stats.DeploymentsAllocated += ws.DeploymentsAllocated
		stats.JobsAllocated += ws.JobsAllocated
		stats.CronjobsAllocated += ws.CronjobsAllocated
		stats.DaemonsetsAllocated += ws.DaemonsetsAllocated
		stats.StatefulsetsAllocated += ws.StatefulsetsAllocated
		stats.IngressesAllocated += ws.IngressesAllocated
	}

	return stats, nil
}

// SyncResourceAllocation 同步工作空间资源分配到项目集群表
// 统计该项目集群下所有工作空间的资源总和，更新到项目集群的 *_allocated 字段
func (m *customOnecProjectClusterModel) SyncResourceAllocation(ctx context.Context, projectClusterId uint64) error {
	// 1. 获取工作空间资源统计
	stats, err := m.GetWorkspaceResourceStats(ctx, projectClusterId)
	if err != nil {
		return fmt.Errorf("获取工作空间资源统计失败: %v", err)
	}

	// 2. 查询项目集群记录，验证是否存在
	projectCluster, err := m.FindOne(ctx, projectClusterId)
	if err != nil {
		return fmt.Errorf("查询项目集群记录失败: %v", err)
	}

	// 3. 构造更新SQL
	updateQuery := `
		UPDATE onec_project_cluster SET
			cpu_allocated = ?,
			mem_allocated = ?,
			storage_allocated = ?,
			gpu_allocated = ?,
			pods_allocated = ?,
			configmap_allocated = ?,
			secret_allocated = ?,
			pvc_allocated = ?,
			ephemeral_storage_allocated = ?,
			service_allocated = ?,
			loadbalancers_allocated = ?,
			nodeports_allocated = ?,
			deployments_allocated = ?,
			jobs_allocated = ?,
			cronjobs_allocated = ?,
			daemonsets_allocated = ?,
			statefulsets_allocated = ?,
			ingresses_allocated = ?,
			updated_at = NOW()
		WHERE id = ? AND is_deleted = 0
	`

	// 4. 生成缓存键
	cacheKeyClusterUuidProjectId := fmt.Sprintf("%s%v:%v",
		cacheIkubeopsOnecProjectClusterClusterUuidProjectIdPrefix,
		projectCluster.ClusterUuid,
		projectCluster.ProjectId)
	cacheKeyId := fmt.Sprintf("%s%v",
		cacheIkubeopsOnecProjectClusterIdPrefix,
		projectClusterId)

	// 5. 执行更新操作并清除缓存
	_, err = m.ExecCtx(ctx, func(ctx context.Context, conn sqlx.SqlConn) (result sql.Result, err error) {
		return conn.ExecCtx(ctx, updateQuery,
			stats.CpuAllocated,
			stats.MemAllocated,
			stats.StorageAllocated,
			stats.GpuAllocated,
			stats.PodsAllocated,
			stats.ConfigmapAllocated,
			stats.SecretAllocated,
			stats.PvcAllocated,
			stats.EphemeralStorageAllocated,
			stats.ServiceAllocated,
			stats.LoadbalancersAllocated,
			stats.NodeportsAllocated,
			stats.DeploymentsAllocated,
			stats.JobsAllocated,
			stats.CronjobsAllocated,
			stats.DaemonsetsAllocated,
			stats.StatefulsetsAllocated,
			stats.IngressesAllocated,
			projectClusterId,
		)
	}, cacheKeyClusterUuidProjectId, cacheKeyId)

	if err != nil {
		return fmt.Errorf("更新项目集群资源分配失败: %v", err)
	}

	return nil
}
