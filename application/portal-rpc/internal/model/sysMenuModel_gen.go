// Code generated by goctl. DO NOT EDIT.
// versions:
//  goctl version: 1.7.3

package model

import (
	"context"
	"database/sql"
	"fmt"
	"strings"
	"time"

	"github.com/zeromicro/go-zero/core/stores/builder"
	"github.com/zeromicro/go-zero/core/stores/cache"
	"github.com/zeromicro/go-zero/core/stores/sqlc"
	"github.com/zeromicro/go-zero/core/stores/sqlx"
	"github.com/zeromicro/go-zero/core/stringx"
)

var (
	sysMenuFieldNames          = builder.RawFieldNames(&SysMenu{})
	sysMenuRows                = strings.Join(sysMenuFieldNames, ",")
	sysMenuRowsExpectAutoSet   = strings.Join(stringx.Remove(sysMenuFieldNames, "`id`", "`create_at`", "`create_time`", "`created_at`", "`update_at`", "`update_time`", "`updated_at`"), ",")
	sysMenuRowsWithPlaceHolder = strings.Join(stringx.Remove(sysMenuFieldNames, "`id`", "`create_at`", "`create_time`", "`created_at`", "`update_at`", "`update_time`", "`updated_at`"), "=?,") + "=?"

	cacheIkubeopsSysMenuIdPrefix   = "cache:ikubeops:sysMenu:id:"
	cacheIkubeopsSysMenuNamePrefix = "cache:ikubeops:sysMenu:name:"
)

type (
	sysMenuModel interface {
		Insert(ctx context.Context, data *SysMenu) (sql.Result, error)

		FindOne(ctx context.Context, id uint64) (*SysMenu, error)
		Search(ctx context.Context, orderStr string, isAsc bool, page, pageSize uint64, queryStr string, args ...any) ([]*SysMenu, uint64, error)
		SearchNoPage(ctx context.Context, orderStr string, isAsc bool, queryStr string, args ...any) ([]*SysMenu, error)
		FindOneByName(ctx context.Context, name string) (*SysMenu, error)
		Update(ctx context.Context, data *SysMenu) error
		Delete(ctx context.Context, id uint64) error
		DeleteSoft(ctx context.Context, id uint64) error
		TransCtx(ctx context.Context, fn func(context.Context, sqlx.Session) error) error
		TransOnSql(ctx context.Context, session sqlx.Session, id uint64, sqlStr string, args ...any) (sql.Result, error)
		ExecSql(ctx context.Context, id uint64, sqlStr string, args ...any) (sql.Result, error)
	}

	defaultSysMenuModel struct {
		sqlc.CachedConn
		table string
	}

	SysMenu struct {
		Id            uint64         `db:"id"`              // 自增主键
		ParentId      uint64         `db:"parent_id"`       // 父菜单ID，顶级菜单为0
		MenuType      int64          `db:"menu_type"`       // 菜单类型（1目录 2菜单 3按钮）
		Name          string         `db:"name"`            // 菜单名称（路由name）
		Path          string         `db:"path"`            // 路由地址
		Component     string         `db:"component"`       // 组件路径
		Redirect      string         `db:"redirect"`        // 重定向地址
		Label         string         `db:"label"`           // 权限标识
		Title         string         `db:"title"`           // 菜单标题（meta.title）
		Icon          string         `db:"icon"`            // 菜单图标
		Sort          int64          `db:"sort"`            // 排序
		Link          string         `db:"link"`            // 外部链接/内嵌地址
		IsEnable      int64          `db:"is_enable"`       // 是否启用（0否 1是）
		IsMenu        int64          `db:"is_menu"`         // 是否为菜单（0否 1是）
		KeepAlive     int64          `db:"keep_alive"`      // 页面缓存（0否 1是）
		IsHide        int64          `db:"is_hide"`         // 是否隐藏（0否 1是）
		IsIframe      int64          `db:"is_iframe"`       // 是否内嵌（0否 1是）
		IsHideTab     int64          `db:"is_hide_tab"`     // 是否在标签页中隐藏（0否 1是）
		ShowBadge     int64          `db:"show_badge"`      // 是否显示徽章（0否 1是）
		ShowTextBadge string         `db:"show_text_badge"` // 文本徽章内容
		IsFirstLevel  int64          `db:"is_first_level"`  // 是否为一级菜单（0否 1是）
		FixedTab      int64          `db:"fixed_tab"`       // 是否固定标签页（0否 1是）
		IsFullPage    int64          `db:"is_full_page"`    // 是否为全屏页面（0否 1是）
		ActivePath    string         `db:"active_path"`     // 激活菜单路径
		Roles         sql.NullString `db:"roles"`           // 角色权限（JSON格式存储数组）
		AuthName      string         `db:"auth_name"`       // 按钮权限名称
		AuthLabel     string         `db:"auth_label"`      // 按钮权限标识
		AuthIcon      string         `db:"auth_icon"`       // 按钮图标
		AuthSort      int64          `db:"auth_sort"`       // 按钮权限排序
		Status        int64          `db:"status"`          // 状态（0停用 1启用）
		IsDeleted     int64          `db:"is_deleted"`      // 是否删除（true: 删除， false: 正常）
		CreateTime    time.Time      `db:"create_time"`     // 创建时间
		UpdateTime    time.Time      `db:"update_time"`     // 更新时间
		CreateBy      string         `db:"create_by"`       // 创建人
		UpdateBy      string         `db:"update_by"`       // 更新人
	}
)

func newSysMenuModel(conn sqlx.SqlConn, c cache.CacheConf, opts ...cache.Option) *defaultSysMenuModel {
	return &defaultSysMenuModel{
		CachedConn: sqlc.NewConn(conn, c, opts...),
		table:      "`sys_menu`",
	}
}

func (m *defaultSysMenuModel) Delete(ctx context.Context, id uint64) error {
	data, err := m.FindOne(ctx, id)
	if err != nil {
		return err
	}

	ikubeopsSysMenuIdKey := fmt.Sprintf("%s%v", cacheIkubeopsSysMenuIdPrefix, id)
	ikubeopsSysMenuNameKey := fmt.Sprintf("%s%v", cacheIkubeopsSysMenuNamePrefix, data.Name)
	_, err = m.ExecCtx(ctx, func(ctx context.Context, conn sqlx.SqlConn) (result sql.Result, err error) {
		query := fmt.Sprintf("delete from %s where `id` = ?", m.table)
		return conn.ExecCtx(ctx, query, id)
	}, ikubeopsSysMenuIdKey, ikubeopsSysMenuNameKey)
	return err
}

func (m *defaultSysMenuModel) DeleteSoft(ctx context.Context, id uint64) error {
	data, err := m.FindOne(ctx, id)
	if err != nil {
		return err
	}
	// 如果记录已软删除，无需再次删除
	if data.IsDeleted == 1 {
		return nil
	}
	ikubeopsSysMenuIdKey := fmt.Sprintf("%s%v", cacheIkubeopsSysMenuIdPrefix, id)
	ikubeopsSysMenuNameKey := fmt.Sprintf("%s%v", cacheIkubeopsSysMenuNamePrefix, data.Name)
	_, err = m.ExecCtx(ctx, func(ctx context.Context, conn sqlx.SqlConn) (result sql.Result, err error) {
		query := fmt.Sprintf("update %s set `is_deleted` = 1 where `id` = ?", m.table)
		return conn.ExecCtx(ctx, query, id)
	}, ikubeopsSysMenuIdKey, ikubeopsSysMenuNameKey)
	return err
}

func (m *defaultSysMenuModel) TransCtx(ctx context.Context, fn func(context.Context, sqlx.Session) error) error {
	return m.TransactCtx(ctx, func(ctx context.Context, session sqlx.Session) error {
		return fn(ctx, session)
	})
}

func (m *defaultSysMenuModel) TransOnSql(ctx context.Context, session sqlx.Session, id uint64, sqlStr string, args ...any) (sql.Result, error) {
	query := strings.ReplaceAll(sqlStr, "{table}", m.table)
	// 如果 id != 0 并且启用了缓存逻辑
	if !isZeroValue(id) {
		// 查询数据（如果需要，确保数据存在）
		data, err := m.FindOne(ctx, id)
		if err != nil {
			return nil, err
		}

		// 缓存相关处理

		ikubeopsSysMenuIdKey := fmt.Sprintf("%s%v", cacheIkubeopsSysMenuIdPrefix, id)
		ikubeopsSysMenuNameKey := fmt.Sprintf("%s%v", cacheIkubeopsSysMenuNamePrefix, data.Name) // 处理缓存逻辑，例如删除或更新缓存
		// 执行带缓存处理的 SQL 操作
		return m.ExecCtx(ctx, func(ctx context.Context, conn sqlx.SqlConn) (sql.Result, error) {
			return session.ExecCtx(ctx, query, args...)
		}, ikubeopsSysMenuIdKey, ikubeopsSysMenuNameKey) // 传递缓存相关的键值

	}

	// 如果 id == 0 或不需要缓存，直接执行 SQL
	return m.ExecCtx(ctx, func(ctx context.Context, conn sqlx.SqlConn) (sql.Result, error) {
		return session.ExecCtx(ctx, query, args...)
	})
}

func (m *defaultSysMenuModel) ExecSql(ctx context.Context, id uint64, sqlStr string, args ...any) (sql.Result, error) {
	// 如果 id != 0 并且启用了缓存逻辑
	query := strings.ReplaceAll(sqlStr, "{table}", m.table)
	if !isZeroValue(id) {
		// 缓存相关处理

		// 查询数据（如果需要，确保数据存在）
		data, err := m.FindOne(ctx, id)
		if err != nil {
			return nil, err
		}

		ikubeopsSysMenuIdKey := fmt.Sprintf("%s%v", cacheIkubeopsSysMenuIdPrefix, id)
		ikubeopsSysMenuNameKey := fmt.Sprintf("%s%v", cacheIkubeopsSysMenuNamePrefix, data.Name) // 处理缓存逻辑，例如删除或更新缓存
		// 执行带缓存处理的 SQL 操作
		return m.ExecCtx(ctx, func(ctx context.Context, conn sqlx.SqlConn) (sql.Result, error) {
			return conn.ExecCtx(ctx, query, args...)
		}, ikubeopsSysMenuIdKey, ikubeopsSysMenuNameKey) // 传递缓存相关的键值

	}

	// 如果 id == 0 或不需要缓存，直接执行 SQL
	return m.ExecCtx(ctx, func(ctx context.Context, conn sqlx.SqlConn) (sql.Result, error) {
		return conn.ExecCtx(ctx, query, args...)
	})
}
func (m *defaultSysMenuModel) FindOne(ctx context.Context, id uint64) (*SysMenu, error) {
	ikubeopsSysMenuIdKey := fmt.Sprintf("%s%v", cacheIkubeopsSysMenuIdPrefix, id)
	var resp SysMenu
	err := m.QueryRowCtx(ctx, &resp, ikubeopsSysMenuIdKey, func(ctx context.Context, conn sqlx.SqlConn, v any) error {
		query := fmt.Sprintf("select %s from %s where `id` = ? AND `is_deleted` = 0 limit 1", sysMenuRows, m.table)
		return conn.QueryRowCtx(ctx, v, query, id)
	})
	switch err {
	case nil:
		return &resp, nil
	case sqlc.ErrNotFound:
		return nil, ErrNotFound
	default:
		return nil, err
	}
}

func (m *defaultSysMenuModel) Search(ctx context.Context, orderStr string, isAsc bool, page, pageSize uint64, queryStr string, args ...any) ([]*SysMenu, uint64, error) {
	// 确保分页参数有效
	if page < 1 {
		page = 1
	}
	if pageSize < 1 {
		pageSize = 20
	}

	// 构造查询条件
	// 添加 `is_deleted` = 0 条件，保证只查询未软删除数据
	// 初始化 WHERE 子句
	where := "WHERE `is_deleted` = 0"
	if queryStr != "" {
		where = fmt.Sprintf("WHERE %s AND `is_deleted` = 0", queryStr)
	}

	// 根据 isAsc 参数确定排序方式
	sortDirection := "ASC"
	if !isAsc {
		sortDirection = "DESC"
	}

	// 如果用户未指定排序字段，则默认使用 id
	if orderStr == "" {
		orderStr = fmt.Sprintf("ORDER BY id %s", sortDirection)
	} else {
		orderStr = strings.TrimSpace(orderStr)
		if !strings.HasPrefix(strings.ToUpper(orderStr), "ORDER BY") {
			orderStr = "ORDER BY " + orderStr
		}
		orderStr = fmt.Sprintf("%s %s", orderStr, sortDirection)
	}

	countQuery := fmt.Sprintf("SELECT COUNT(1) FROM %s %s", m.table, where)

	var total uint64
	var resp []*SysMenu
	err := m.QueryRowNoCacheCtx(ctx, &total, countQuery, args...)
	if err != nil {
		return nil, 0, err
	}
	if total == 0 {
		// 无匹配记录
		return resp, 0, ErrNotFound
	}
	offset := (page - 1) * pageSize
	dataQuery := fmt.Sprintf("SELECT %s FROM %s %s %s LIMIT %d,%d", sysMenuRows, m.table, where, orderStr, offset, pageSize)

	err = m.QueryRowsNoCacheCtx(ctx, &resp, dataQuery, args...)
	if err != nil {
		return nil, 0, err
	}

	return resp, total, nil
}

func (m *defaultSysMenuModel) SearchNoPage(ctx context.Context, orderStr string, isAsc bool, queryStr string, args ...any) ([]*SysMenu, error) {
	// 处理 nil 参数
	if args == nil {
		args = []any{}
	}
	// 初始化 WHERE 子句
	where := "WHERE `is_deleted` = 0"
	// 处理查询条件和参数
	var finalArgs []any
	if queryStr != "" {
		where = fmt.Sprintf("WHERE %s AND `is_deleted` = 0", queryStr)
		// 只有当有查询条件时才使用参数
		if len(args) > 0 {
			finalArgs = args
		}
	}

	// 根据 isAsc 参数确定排序方式
	sortDirection := "ASC"
	if !isAsc {
		sortDirection = "DESC"
	}
	// 如果用户未指定排序字段，则默认使用 id
	if orderStr == "" {
		orderStr = fmt.Sprintf("ORDER BY id %s", sortDirection)
	} else {
		orderStr = strings.TrimSpace(orderStr)
		if !strings.HasPrefix(strings.ToUpper(orderStr), "ORDER BY") {
			orderStr = "ORDER BY " + orderStr
		}
		orderStr = fmt.Sprintf("%s %s", orderStr, sortDirection)
	}
	dataQuery := fmt.Sprintf("SELECT %s FROM %s %s %s", sysMenuRows, m.table, where, orderStr)
	var resp []*SysMenu
	// 根据是否有参数来调用
	var err error
	if len(finalArgs) > 0 {
		err = m.QueryRowsNoCacheCtx(ctx, &resp, dataQuery, finalArgs...)
	} else {
		err = m.QueryRowsNoCacheCtx(ctx, &resp, dataQuery)
	}
	switch err {
	case nil:
		return resp, nil
	case sqlx.ErrNotFound:
		return nil, ErrNotFound
	default:
		return nil, err
	}
}
func (m *defaultSysMenuModel) FindOneByName(ctx context.Context, name string) (*SysMenu, error) {
	ikubeopsSysMenuNameKey := fmt.Sprintf("%s%v", cacheIkubeopsSysMenuNamePrefix, name)
	var resp SysMenu
	err := m.QueryRowIndexCtx(ctx, &resp, ikubeopsSysMenuNameKey, m.formatPrimary, func(ctx context.Context, conn sqlx.SqlConn, v any) (i any, e error) {
		query := fmt.Sprintf("select %s from %s where `name` = ? AND `is_deleted` = 0  limit 1", sysMenuRows, m.table)
		if err := conn.QueryRowCtx(ctx, &resp, query, name); err != nil {
			return nil, err
		}
		return resp.Id, nil
	}, m.queryPrimary)
	switch err {
	case nil:
		return &resp, nil
	case sqlc.ErrNotFound:
		return nil, ErrNotFound
	default:
		return nil, err
	}
}

func (m *defaultSysMenuModel) Insert(ctx context.Context, data *SysMenu) (sql.Result, error) {
	ikubeopsSysMenuIdKey := fmt.Sprintf("%s%v", cacheIkubeopsSysMenuIdPrefix, data.Id)
	ikubeopsSysMenuNameKey := fmt.Sprintf("%s%v", cacheIkubeopsSysMenuNamePrefix, data.Name)
	ret, err := m.ExecCtx(ctx, func(ctx context.Context, conn sqlx.SqlConn) (result sql.Result, err error) {
		query := fmt.Sprintf("insert into %s (%s) values (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)", m.table, sysMenuRowsExpectAutoSet)
		return conn.ExecCtx(ctx, query, data.ParentId, data.MenuType, data.Name, data.Path, data.Component, data.Redirect, data.Label, data.Title, data.Icon, data.Sort, data.Link, data.IsEnable, data.IsMenu, data.KeepAlive, data.IsHide, data.IsIframe, data.IsHideTab, data.ShowBadge, data.ShowTextBadge, data.IsFirstLevel, data.FixedTab, data.IsFullPage, data.ActivePath, data.Roles, data.AuthName, data.AuthLabel, data.AuthIcon, data.AuthSort, data.Status, data.IsDeleted, data.CreateBy, data.UpdateBy)
	}, ikubeopsSysMenuIdKey, ikubeopsSysMenuNameKey)
	return ret, err
}

func (m *defaultSysMenuModel) Update(ctx context.Context, newData *SysMenu) error {
	data, err := m.FindOne(ctx, newData.Id)
	if err != nil {
		return err
	}

	ikubeopsSysMenuIdKey := fmt.Sprintf("%s%v", cacheIkubeopsSysMenuIdPrefix, data.Id)
	ikubeopsSysMenuNameKey := fmt.Sprintf("%s%v", cacheIkubeopsSysMenuNamePrefix, data.Name)
	_, err = m.ExecCtx(ctx, func(ctx context.Context, conn sqlx.SqlConn) (result sql.Result, err error) {
		query := fmt.Sprintf("update %s set %s where `id` = ?", m.table, sysMenuRowsWithPlaceHolder)
		return conn.ExecCtx(ctx, query, newData.ParentId, newData.MenuType, newData.Name, newData.Path, newData.Component, newData.Redirect, newData.Label, newData.Title, newData.Icon, newData.Sort, newData.Link, newData.IsEnable, newData.IsMenu, newData.KeepAlive, newData.IsHide, newData.IsIframe, newData.IsHideTab, newData.ShowBadge, newData.ShowTextBadge, newData.IsFirstLevel, newData.FixedTab, newData.IsFullPage, newData.ActivePath, newData.Roles, newData.AuthName, newData.AuthLabel, newData.AuthIcon, newData.AuthSort, newData.Status, newData.IsDeleted, newData.CreateBy, newData.UpdateBy, newData.Id)
	}, ikubeopsSysMenuIdKey, ikubeopsSysMenuNameKey)
	return err
}

func (m *defaultSysMenuModel) formatPrimary(primary any) string {
	return fmt.Sprintf("%s%v", cacheIkubeopsSysMenuIdPrefix, primary)
}

func (m *defaultSysMenuModel) queryPrimary(ctx context.Context, conn sqlx.SqlConn, v, primary any) error {
	query := fmt.Sprintf("select %s from %s where `id` = ? AND `is_deleted` = 0 limit 1", sysMenuRows, m.table)
	return conn.QueryRowCtx(ctx, v, query, primary)
}

func (m *defaultSysMenuModel) tableName() string {
	return m.table
}
